    <title>CAP å®šç†å¯è§†åŒ–æ¼”ç¤º</title>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        
        .container { width: 100%; max-width: 1000px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .controls-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid #2196f3; }
        
        .mode-selector { display: flex; gap: 10px; }
        .mode-btn { padding: 8px 16px; border: 2px solid #2196f3; background: white; color: #2196f3; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .mode-btn.active { background: #2196f3; color: white; }
        
        .canvas { position: relative; height: 400px; background: #fafafa; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        
        /* Nodes */
        .node {
            width: 100px; height: 100px; border-radius: 50%; background: white; border: 3px solid #333;
            position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; z-index: 2; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .node.master { border-color: #ff9800; }
        .node-title { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .node-data { font-size: 1.2rem; color: #333; }
        
        /* Network Lines */
        .link {
            position: absolute; height: 4px; background: #4caf50; transform-origin: 0 50%; z-index: 1; cursor: pointer; transition: all 0.3s;
        }
        .link:hover { height: 8px; box-shadow: 0 0 5px #4caf50; }
        .link.broken { background: #f44336; border-style: dashed; opacity: 0.6; }
        .link-label {
            position: absolute; background: white; padding: 2px 5px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #ccc;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 3;
        }

        /* Client */
        .client {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: #333; color: white; border-radius: 8px; cursor: pointer; z-index: 10;
            display: flex; gap: 10px;
        }
        .client button { background: #555; color: white; border: 1px solid #777; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .client button:hover { background: #777; }

        /* Messages */
        .packet {
            position: absolute; width: 16px; height: 16px; background: #2196f3; border-radius: 50%; z-index: 5;
            transition: all 0.5s linear; display: none; box-shadow: 0 0 5px #2196f3;
        }

        /* Logs & Narrative */
        .narrative {
            background: #fff3e0; color: #e65100; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #ff9800; min-height: 40px; display: flex; align-items: center;
        }
        
        .log-console {
            background: #212121; color: #00e676; padding: 15px; border-radius: 8px; 
            font-family: 'Consolas', monospace; height: 150px; overflow-y: auto;
            font-size: 0.9rem; border: 1px solid #444;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }

        /* Guide Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 700px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; }
        
        .guide-step { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .guide-step:last-child { border-bottom: none; }
        .guide-step h3 { color: #2196f3; margin-top: 0; }

        /* Status Indicators */
        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-left: 10px;
        }
        .status-cp { background: #e3f2fd; color: #1565c0; border: 1px solid #1565c0; }
        .status-ap { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }

    </style>
</head>
<body>
    <h1>CAP å®šç†å¯è§†åŒ–æ¼”ç¤º (CAP Theorem)</h1>
    
    <div class="container">
        <div class="controls-top">
            <div>
                <strong>ç³»ç»Ÿæ¨¡å¼ (System Mode):</strong>
                <div class="mode-selector" style="display: inline-flex; vertical-align: middle; margin-left: 10px;">
                    <button class="mode-btn active" onclick="setMode('CP')" id="btn-cp">CP (ä¸€è‡´æ€§ä¼˜å…ˆ)</button>
                    <button class="mode-btn" onclick="setMode('AP')" id="btn-ap">AP (å¯ç”¨æ€§ä¼˜å…ˆ)</button>
                </div>
            </div>
            <button onclick="showGuide()" style="background: #607d8b; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">ğŸ“– æ¼”ç¤ºæŒ‡å— (Guide)</button>
        </div>

        <div class="narrative" id="narrative">
            æ¬¢è¿ï¼è¯·é€‰æ‹©æ¨¡å¼ (CP æˆ– AP) å¹¶å°è¯•å†™å…¥æ•°æ®ã€‚ç‚¹å‡»ç»¿è‰²çš„è¿çº¿å¯ä»¥æ¨¡æ‹Ÿâ€œç½‘ç»œåˆ†åŒºâ€æ•…éšœã€‚
        </div>

        <div class="canvas" id="canvas">
            <!-- Packet Element -->
            <div id="packet" class="packet"></div>

            <!-- Nodes -->
            <div class="node master" style="top: 50px; left: 50%; transform: translateX(-50%);" id="node1">
                <div class="node-title">èŠ‚ç‚¹ A (Leader)</div>
                <div class="node-data">v: 0</div>
            </div>
            <div class="node" style="bottom: 100px; left: 20%;" id="node2">
                <div class="node-title">èŠ‚ç‚¹ B</div>
                <div class="node-data">v: 0</div>
            </div>
            <div class="node" style="bottom: 100px; right: 20%;" id="node3">
                <div class="node-title">èŠ‚ç‚¹ C</div>
                <div class="node-data">v: 0</div>
            </div>

            <!-- Links (SVG for lines) -->
            <svg style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none;">
                <line id="link1-2" x1="50%" y1="100" x2="25%" y2="300" stroke="#4caf50" stroke-width="4" style="pointer-events: auto; cursor: pointer;" onclick="toggleLink('link1-2')"/>
                <line id="link1-3" x1="50%" y1="100" x2="75%" y2="300" stroke="#4caf50" stroke-width="4" style="pointer-events: auto; cursor: pointer;" onclick="toggleLink('link1-3')"/>
                <line id="link2-3" x1="25%" y1="300" x2="75%" y2="300" stroke="#4caf50" stroke-width="4" style="pointer-events: auto; cursor: pointer;" onclick="toggleLink('link2-3')"/>
            </svg>
            
            <!-- Link Status Labels -->
            <div id="label1-2" class="link-label" style="top: 200px; left: 37%;">è¿æ¥æ­£å¸¸</div>
            <div id="label1-3" class="link-label" style="top: 200px; left: 63%;">è¿æ¥æ­£å¸¸</div>
            <div id="label2-3" class="link-label" style="top: 300px; left: 50%;">è¿æ¥æ­£å¸¸</div>

            <!-- Client -->
            <div class="client" id="client">
                <span>å®¢æˆ·ç«¯ (Client):</span>
                <button onclick="clientWrite()">å†™å…¥ (Write v+1)</button>
                <button onclick="clientRead()">è¯»å– (Read)</button>
            </div>
        </div>

        <div class="log-console" id="log-console">
            <div class="log-entry">> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆã€‚æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´ (v: 0)ã€‚</div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('guide-modal').style.display='none'">&times;</span>
            <h2>ğŸ“– CAP å®šç†æ¼”ç¤ºæŒ‡å—</h2>
            
            <div class="guide-step">
                <h3>1. ä»€ä¹ˆæ˜¯ CAP?</h3>
                <p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä½ åªèƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹ï¼š</p>
                <ul>
                    <li><strong>Consistency (ä¸€è‡´æ€§):</strong> æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çœ‹åˆ°çš„æ•°æ®æ˜¯ç›¸åŒçš„ã€‚</li>
                    <li><strong>Availability (å¯ç”¨æ€§):</strong> æ¯ä¸ªè¯·æ±‚éƒ½èƒ½æ”¶åˆ°å“åº”ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰ï¼Œä½†ä¸ä¿è¯æ˜¯æœ€æ–°çš„æ•°æ®ã€‚</li>
                    <li><strong>Partition Tolerance (åˆ†åŒºå®¹é”™æ€§):</strong> ç³»ç»Ÿåœ¨éƒ¨åˆ†èŠ‚ç‚¹é€šä¿¡å¤±è´¥ï¼ˆç½‘ç»œåˆ†åŒºï¼‰æ—¶ä»èƒ½ç»§ç»­è¿è¡Œã€‚</li>
                </ul>
                <p><em>ç”±äºç½‘ç»œåˆ†åŒº (P) æ˜¯ä¸å¯é¿å…çš„ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»åœ¨ C å’Œ A ä¹‹é—´åšé€‰æ‹©ã€‚</em></p>
            </div>

            <div class="guide-step">
                <h3>2. CP æ¨¡å¼ (ä¸€è‡´æ€§ > å¯ç”¨æ€§)</h3>
                <p><strong>åœºæ™¯:</strong> é“¶è¡Œè½¬è´¦ç³»ç»Ÿã€åˆ†å¸ƒå¼é” (Zookeeper/Etcd)ã€‚</p>
                <p><strong>è¡Œä¸º:</strong> å¦‚æœå‘ç”Ÿç½‘ç»œåˆ†åŒºï¼ˆä¾‹å¦‚èŠ‚ç‚¹ A æ— æ³•è”ç³» B/Cï¼‰ï¼ŒèŠ‚ç‚¹ A ä¼š<strong>æ‹’ç»å†™å…¥</strong>ï¼Œä»¥é˜²æ­¢æ•°æ®ä¸ä¸€è‡´ã€‚ç³»ç»Ÿé€‰æ‹©â€œä¸å¯ç”¨â€æ¥ä¿è¯â€œæ•°æ®æ­£ç¡®â€ã€‚</p>
                <p><strong>è¯•ä¸€è¯•:</strong> é€‰æ‹© CP æ¨¡å¼ -> ç‚¹å‡» A å’Œ B ä¹‹é—´çš„ç»¿çº¿æ–­å¼€è¿æ¥ -> å°è¯•å†™å…¥ã€‚</p>
            </div>

            <div class="guide-step">
                <h3>3. AP æ¨¡å¼ (å¯ç”¨æ€§ > ä¸€è‡´æ€§)</h3>
                <p><strong>åœºæ™¯:</strong> ç¤¾äº¤åª’ä½“ç‚¹èµã€DNSã€Eurekaã€‚</p>
                <p><strong>è¡Œä¸º:</strong> å¦‚æœå‘ç”Ÿç½‘ç»œåˆ†åŒºï¼ŒèŠ‚ç‚¹ A ä»ç„¶<strong>æ¥å—å†™å…¥</strong>ã€‚ä½†æ˜¯ï¼ŒèŠ‚ç‚¹ B å’Œ C æ— æ³•æ”¶åˆ°æ›´æ–°ã€‚ç³»ç»Ÿä¿æŒâ€œå¯ç”¨â€ï¼Œä½†æ•°æ®æš‚æ—¶â€œä¸ä¸€è‡´â€ã€‚</p>
                <p><strong>è¯•ä¸€è¯•:</strong> é€‰æ‹© AP æ¨¡å¼ -> æ–­å¼€è¿æ¥ -> å†™å…¥ã€‚æ³¨æ„èŠ‚ç‚¹ A æ›´æ–°äº†ï¼Œä½† B/C è¿˜æ˜¯æ—§æ•°æ®ã€‚</p>
            </div>
            
            <button onclick="document.getElementById('guide-modal').style.display='none'" style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem;">å¼€å§‹æ¼”ç¤º</button>
        </div>
    </div>

    <script>
        let currentMode = 'CP';
        let dataValue = 0;
        let links = {
            'link1-2': true, // A-B
            'link1-3': true, // A-C
            'link2-3': true  // B-C
        };
        let nodeData = {
            'node1': 0,
            'node2': 0,
            'node3': 0
        };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-cp').className = mode === 'CP' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btn-ap').className = mode === 'AP' ? 'mode-btn active' : 'mode-btn';
            
            const msg = mode === 'CP' 
                ? "å·²åˆ‡æ¢åˆ° <strong>CP æ¨¡å¼</strong>ã€‚ç³»ç»Ÿå°†ä¼˜å…ˆä¿è¯ä¸€è‡´æ€§ã€‚å†™å…¥æ“ä½œéœ€è¦å¤§å¤šæ•°èŠ‚ç‚¹ç¡®è®¤ã€‚"
                : "å·²åˆ‡æ¢åˆ° <strong>AP æ¨¡å¼</strong>ã€‚ç³»ç»Ÿå°†ä¼˜å…ˆä¿è¯å¯ç”¨æ€§ã€‚å³ä½¿å‘ç”Ÿåˆ†åŒºï¼Œå†™å…¥æ“ä½œä¹Ÿä¼šåœ¨æœ¬åœ°æˆåŠŸã€‚";
            
            narrate(msg);
            log(`ç³»ç»Ÿæ¨¡å¼å·²åˆ‡æ¢ä¸º ${mode}ã€‚`);
        }

        function toggleLink(id) {
            links[id] = !links[id];
            const line = document.getElementById(id);
            const label = document.getElementById(id.replace('link', 'label'));
            
            if (links[id]) {
                line.setAttribute('stroke', '#4caf50');
                line.setAttribute('stroke-dasharray', '');
                label.innerText = "è¿æ¥æ­£å¸¸";
                label.style.color = "green";
                log(`ç½‘ç»œé“¾è·¯ ${id} å·²æ¢å¤ã€‚`);
            } else {
                line.setAttribute('stroke', '#f44336');
                line.setAttribute('stroke-dasharray', '5,5');
                label.innerText = "å·²æ–­å¼€";
                label.style.color = "red";
                log(`ç½‘ç»œé“¾è·¯ ${id} å·²æ–­å¼€ (æ¨¡æ‹Ÿåˆ†åŒº)ã€‚`, 'warn');
            }
            
            // Check partition status
            checkPartition();
        }

        function checkPartition() {
            const a_b = links['link1-2'];
            const a_c = links['link1-3'];
            
            if (!a_b && !a_c) {
                narrate("âš ï¸ <strong>ç½‘ç»œåˆ†åŒºè­¦å‘Š!</strong> èŠ‚ç‚¹ A ä¸ Bã€C å¤±å»è”ç³»ã€‚");
            }
        }

        async function clientWrite() {
            const newValue = nodeData['node1'] + 1;
            log(`CMD: å®¢æˆ·ç«¯è¯·æ±‚å†™å…¥ (v=${newValue}) åˆ°èŠ‚ç‚¹ A...`);
            
            // Visual: Packet from Client to Node A
            await animatePacket('client', 'node1');

            // Check connections from A
            const canReachB = links['link1-2'];
            const canReachC = links['link1-3'];
            
            if (currentMode === 'CP') {
                // CP Mode: Needs Quorum (Majority). Total 3 nodes, Majority = 2.
                if (canReachB || canReachC) {
                    // Success scenario
                    processWriteSuccess(newValue, canReachB, canReachC);
                } else {
                    // Failure scenario
                    narrate(`âŒ <strong>å†™å…¥å¤±è´¥ (CP æ¨¡å¼)</strong>ã€‚èŠ‚ç‚¹ A æ— æ³•è”ç³»å¤§å¤šæ•°èŠ‚ç‚¹ (éœ€è¦ 2 ä¸ª)ã€‚ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œæ‹’ç»å†™å…¥ã€‚`);
                    log(`å†™å…¥é”™è¯¯: æ£€æµ‹åˆ°åˆ†åŒºã€‚æ— æ³•å¤åˆ¶æ•°æ®ã€‚CP æ¨¡å¼æ‹’ç»å†™å…¥ä»¥é˜²æ­¢è„‘è£‚ã€‚`, 'error');
                    flashNode('node1', 'red');
                }
            } else {
                // AP Mode: Always accept write locally
                processWriteSuccess(newValue, canReachB, canReachC);
                if (!canReachB && !canReachC) {
                    narrate(`âš ï¸ <strong>å†™å…¥æˆåŠŸ (AP æ¨¡å¼)</strong>ã€‚èŠ‚ç‚¹ A å·²æ›´æ–°ï¼Œä½†æ— æ³•å¤åˆ¶åˆ° B æˆ– Cã€‚ç³»ç»Ÿå‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚`);
                    log(`å†™å…¥æˆåŠŸ (æœ¬åœ°): èŠ‚ç‚¹ A æ›´æ–°ä¸º v=${newValue}ã€‚å¤åˆ¶å¤±è´¥ (åˆ†åŒº)ã€‚`, 'warn');
                }
            }
        }

        async function processWriteSuccess(val, sendToB, sendToC) {
            // Update Leader
            updateNode('node1', val);
            flashNode('node1', 'green');
            
            if (sendToB) {
                animatePacket('node1', 'node2').then(() => updateNode('node2', val));
            }
            if (sendToC) {
                animatePacket('node1', 'node3').then(() => updateNode('node3', val));
            }
            
            if (sendToB && sendToC) {
                narrate(`âœ… <strong>å†™å…¥æˆåŠŸ</strong>ã€‚æ•°æ®å·²å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ã€‚`);
                log(`å†™å…¥æäº¤ã€‚v=${val} å·²å¤åˆ¶åˆ° B å’Œ Cã€‚`);
            } else if (sendToB || sendToC) {
                 narrate(`âœ… <strong>å†™å…¥æˆåŠŸ</strong>ã€‚æ•°æ®å·²å¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ã€‚`);
                 log(`å†™å…¥æäº¤ã€‚v=${val} å·²å¤åˆ¶åˆ°å¯ç”¨èŠ‚ç‚¹ã€‚`);
            }
        }

        function clientRead() {
            // Randomly read from a node to show inconsistency
            const nodes = ['node1', 'node2', 'node3'];
            const target = nodes[Math.floor(Math.random() * nodes.length)];
            const val = nodeData[target];
            
            log(`CMD: å®¢æˆ·ç«¯ä» ${target} è¯»å–... å€¼ = ${val}`);
            narrate(`å®¢æˆ·ç«¯ä» <strong>${target}</strong> è¯»å–: å€¼ = ${val}`);
            flashNode(target, 'blue');
            animatePacket('client', target);
        }

        function updateNode(id, val) {
            nodeData[id] = val;
            document.querySelector(`#${id} .node-data`).innerText = `v: ${val}`;
        }

        function flashNode(id, color) {
            const node = document.getElementById(id);
            const originalBorder = node.style.borderColor;
            node.style.borderColor = color;
            node.style.boxShadow = `0 0 15px ${color}`;
            setTimeout(() => {
                node.style.borderColor = '';
                node.style.boxShadow = '';
            }, 500);
        }

        function animatePacket(fromId, toId) {
            return new Promise(resolve => {
                const fromEl = document.getElementById(fromId);
                const toEl = document.getElementById(toId);
                const packet = document.getElementById('packet');
                
                // Get coordinates
                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                
                // Calculate relative positions
                const startX = fromRect.left + fromRect.width/2 - canvasRect.left;
                const startY = fromRect.top + fromRect.height/2 - canvasRect.top;
                const endX = toRect.left + toRect.width/2 - canvasRect.left;
                const endY = toRect.top + toRect.height/2 - canvasRect.top;
                
                packet.style.display = 'block';
                packet.style.left = startX + 'px';
                packet.style.top = startY + 'px';
                packet.style.transition = 'none';
                
                // Force reflow
                void packet.offsetWidth;
                
                packet.style.transition = 'all 0.5s linear';
                packet.style.left = endX + 'px';
                packet.style.top = endY + 'px';
                
                setTimeout(() => {
                    packet.style.display = 'none';
                    resolve();
                }, 500);
            });
        }

        function narrate(html) {
            document.getElementById('narrative').innerHTML = html;
        }

        function log(msg, type='info') {
            const consoleDiv = document.getElementById('log-console');
            const entry = document.createElement('div');
            entry.className = `log-entry`;
            if(type==='error') entry.style.color = '#ff5252';
            if(type==='warn') entry.style.color = '#ffb74d';
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color:#888">[${time}]</span> ${msg}`;
            
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function showGuide() {
            document.getElementById('guide-modal').style.display = 'flex';
        }

        // Init
        showGuide();

    </script>
</body>
</html>
