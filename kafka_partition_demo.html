<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Interactive Demo</title>
    <style>
        :root {
            --primary: #2196f3;
            --secondary: #673ab7;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333;
            --border: #e0e0e0;
        }
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Navbar */
        .navbar {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .brand { font-size: 1.2rem; font-weight: bold; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .nav-tabs { display: flex; gap: 5px; height: 100%; }
        .nav-tab {
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .nav-tab:hover { background: #f9f9f9; color: var(--primary); }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Main Content Area */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card { 
            background: var(--card-bg); 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
            padding: 20px; 
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .card h3 { margin-top: 0; font-size: 1rem; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* Buttons */
        button { 
            padding: 8px 16px; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 0.85rem;
            transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #666; }

        /* Simulation Elements */
        .broker-container { display: flex; gap: 15px; }
        .broker-col { flex: 1; background: #fafafa; border: 1px solid #eee; border-radius: 6px; overflow: hidden; }
        .broker-header { padding: 8px; text-align: center; font-weight: bold; font-size: 0.9rem; background: #eee; border-bottom: 1px solid #ddd; }
        .broker-body { padding: 10px; min-height: 150px; }
        
        .partition-replica { 
            background: white; border: 1px solid #ddd; border-radius: 4px; padding: 6px; margin-bottom: 8px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.85rem;
        }
        .partition-replica.leader { border-left: 4px solid var(--success); }
        .partition-replica.follower { border-left: 4px solid #9e9e9e; }
        
        .msg-queue { height: 12px; background: #f0f0f0; border-radius: 2px; margin-top: 4px; display: flex; gap: 1px; overflow: hidden; }
        .msg-dot { width: 8px; height: 100%; background: var(--warning); }

        .consumer-circle {
            width: 60px; height: 60px; background: var(--success); color: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; margin: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .log-console {
            background: #263238; color: #80cbc4; padding: 15px; border-radius: 6px; 
            font-family: 'Consolas', monospace; height: 300px; overflow-y: auto; font-size: 0.8rem;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #37474f; padding-bottom: 2px; }

        /* Knowledge Base Styles */
        .kb-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; }
        .kb-section h2 { color: var(--secondary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .concept-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; }
        .tag-config { background: #e3f2fd; color: #1565c0; font-family: monospace; }

        /* Zero Copy Animation */
        .zc-stage { 
            background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #eee; 
            position: relative; height: 140px; margin-top: 20px; 
            overflow-x: auto; 
        }
        .zc-container-inner {
            position: relative; min-width: 600px; height: 100%; margin: 0 auto;
        }
        
        .zc-node { 
            position: absolute; top: 40px; width: 80px; height: 60px; 
            display: flex; align-items: center; justify-content: center; 
            background: #607d8b; color: white; border-radius: 6px; font-size: 0.8rem; font-weight: bold; z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .zc-packet { width: 20px; height: 20px; background: var(--danger); border-radius: 50%; position: absolute; top: 60px; z-index: 3; display: none; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        
        /* Arrows & Indicators */
        .zc-arrow { position: absolute; top: 68px; height: 4px; z-index: 1; }
        .zc-arrow::after { content: ''; position: absolute; right: -6px; top: -4px; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 6px solid; }
        
        .arrow-dma { background: #2196f3; } /* Blue */
        .arrow-dma::after { border-left-color: #2196f3; }
        
        .arrow-cpu { background: #f44336; } /* Red */
        .arrow-cpu::after { border-left-color: #f44336; }
        
        .zc-label-sm { position: absolute; font-size: 0.6rem; text-align: center; width: 100%; top: -15px; font-weight: bold; }
        
        .switch-icon { position: absolute; top: 15px; font-size: 1.2rem; color: #9c27b0; font-weight: bold; z-index: 4; text-align: center; width: 30px; }
        .switch-label { font-size: 0.6rem; color: #9c27b0; display: block; line-height: 1; margin-top: -2px; }

        @keyframes move-std { 
            0% { left: 30px; } 
            25% { left: 160px; } 
            50% { left: 290px; } 
            75% { left: 420px; } 
            100% { left: 550px; } 
        }
        @keyframes move-zc { 
            0% { left: 30px; } 
            40% { left: 240px; } 
            100% { left: 510px; } 
        }

        /* Interview Cards */
        .interview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .qa-card { background: white; padding: 20px; border-radius: 8px; border-left: 4px solid var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .qa-q { font-weight: bold; color: #333; margin-bottom: 10px; font-size: 1.05rem; }
        .qa-a { color: #555; line-height: 1.5; font-size: 0.95rem; }

    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">
            <span style="font-size:1.5rem;">ğŸš€</span> Kafka Visualizer
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('simulation')">Dashboard (æ¼”ç¤º)</div>
            <div class="nav-tab" onclick="switchTab('knowledge')">Knowledge Base (åŸç†)</div>
            <div class="nav-tab" onclick="switchTab('interview')">Interview Prep (é¢è¯•)</div>
        </div>
        <div>
            <button class="btn-outline" onclick="window.location.reload()">Reset</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- VIEW 1: SIMULATION DASHBOARD -->
        <div id="view-simulation" class="view-section active">
            <div class="dashboard-grid">
                <!-- Left Col: Controls -->
                <div class="col-controls">
                    <div class="card">
                        <h3>Cluster Control</h3>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <button class="btn-danger" style="flex:1" onclick="toggleBroker(1)">Toggle B1</button>
                            <button class="btn-danger" style="flex:1" onclick="toggleBroker(2)">Toggle B2</button>
                        </div>
                        <button class="btn-secondary" style="width:100%" onclick="triggerPreferredLeaderElection()">âš–ï¸ Rebalance Leaders</button>
                    </div>

                    <div class="card">
                        <h3>Producer</h3>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button class="btn-primary" onclick="produceMessage()">Produce (Round Robin)</button>
                            <button class="btn-secondary" style="background:#e91e63" onclick="produceKeyedMessage()">Produce (Keyed/Hash)</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Scenarios</h3>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button class="btn-outline" onclick="scenarioOrdering()">1. Ordering (é¡ºåºæ€§)</button>
                            <button class="btn-outline" onclick="scenarioIdle()">2. Idle Consumers</button>
                            <button class="btn-outline" onclick="scenarioLag()">3. Consumer Lag</button>
                            <button class="btn-danger" onclick="scenarioFailover()">4. HA Failover Demo</button>
                        </div>
                    </div>
                </div>

                <!-- Middle Col: Visualization -->
                <div class="col-vis">
                    <div class="card">
                        <h3>Topic: "user-events" (4 Partitions)</h3>
                        <div class="broker-container">
                            <div class="broker-col" id="broker-col-1">
                                <div class="broker-header" id="broker-header-1">Broker 1</div>
                                <div class="broker-body" id="broker-partitions-1"></div>
                            </div>
                            <div class="broker-col" id="broker-col-2">
                                <div class="broker-header" id="broker-header-2">Broker 2</div>
                                <div class="broker-body" id="broker-partitions-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Consumer Group: "group-1"</h3>
                        <div style="margin-bottom:15px;">
                            <button class="btn-success" onclick="addConsumer()">+ Add Consumer</button>
                            <button class="btn-danger" onclick="removeConsumer()">- Remove</button>
                        </div>
                        <div id="consumers" style="display:flex; flex-wrap:wrap;"></div>
                    </div>
                </div>

                <!-- Right Col: Logs -->
                <div class="col-logs">
                    <div class="card" style="height:100%; display:flex; flex-direction:column;">
                        <h3>System Logs</h3>
                        <div class="log-console" id="log">
                            <div class="log-entry">> System Ready.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: KNOWLEDGE BASE -->
        <div id="view-knowledge" class="view-section">
            <div class="kb-grid">
                <!-- Theory -->
                <div class="kb-section">
                    <h2>Kafka Core Concepts</h2>
                    
                    <div class="concept-box">
                        <h3 style="color:#2196f3">1. Zero Copy (é›¶æ‹·è´) vs Standard I/O</h3>
                        <p>å¯¹æ¯”ä¼ ç»Ÿ I/O (4æ¬¡æ‹·è´/åˆ‡æ¢) ä¸ Zero Copy (2æ¬¡æ‹·è´/åˆ‡æ¢) çš„åŒºåˆ«ã€‚</p>
                        
                        <!-- Legend -->
                        <div style="display:flex; gap:15px; margin-bottom:10px; font-size:0.8rem; background:#f5f5f5; padding:8px; border-radius:4px;">
                            <div style="display:flex; align-items:center; gap:5px;"><div style="width:15px; height:4px; background:#2196f3;"></div> DMA Copy</div>
                            <div style="display:flex; align-items:center; gap:5px;"><div style="width:15px; height:4px; background:#f44336;"></div> CPU Copy</div>
                            <div style="display:flex; align-items:center; gap:5px;"><span style="color:#9c27b0; font-weight:bold;">âš¡</span> Context Switch</div>
                        </div>

                        <!-- Standard I/O -->
                        <div style="margin-top:15px; font-weight:bold; color:#555; display:flex; justify-content:space-between;">
                            <span>âŒ Standard I/O (Slow)</span>
                            <span style="font-size:0.8rem; color:#999;">4 Copies, 4 Context Switches</span>
                        </div>
                        <div class="zc-stage">
                            <div class="zc-container-inner">
                                <!-- Nodes -->
                                <div class="zc-node" style="left:0px; top:40px; background:#795548;">Disk</div>
                                <div class="zc-node" style="left:130px; top:40px; background:#ff9800;">Kernel<br>Read</div>
                                <div class="zc-node" style="left:260px; top:40px; background:#9c27b0;">User<br>Buffer</div>
                                <div class="zc-node" style="left:390px; top:40px; background:#ff9800;">Socket<br>Buffer</div>
                                <div class="zc-node" style="left:520px; top:40px; background:#2196f3;">NIC</div>

                                <!-- Arrows -->
                                <div class="zc-arrow arrow-dma" style="left:80px; width:50px; top:70px;">
                                    <div class="zc-label-sm" style="color:#2196f3">DMA</div>
                                </div>
                                
                                <div class="zc-arrow arrow-cpu" style="left:210px; width:50px; top:70px;">
                                    <div class="zc-label-sm" style="color:#f44336">CPU</div>
                                </div>
                                <div class="switch-icon" style="left:220px;" title="Context Switch">âš¡<span class="switch-label">Switch</span></div>

                                <div class="zc-arrow arrow-cpu" style="left:340px; width:50px; top:70px;">
                                    <div class="zc-label-sm" style="color:#f44336">CPU</div>
                                </div>
                                <div class="switch-icon" style="left:350px;" title="Context Switch">âš¡<span class="switch-label">Switch</span></div>

                                <div class="zc-arrow arrow-dma" style="left:470px; width:50px; top:70px;">
                                    <div class="zc-label-sm" style="color:#2196f3">DMA</div>
                                </div>

                                <div class="zc-packet" id="pkt-std"></div>
                            </div>
                        </div>
                        <button class="btn-outline" style="width:100%; margin-top:5px;" onclick="playAnim('std')">â–¶ï¸ Play Standard I/O Animation</button>

                        <!-- Zero Copy -->
                        <div style="margin-top:25px; font-weight:bold; color:#555; display:flex; justify-content:space-between;">
                            <span>âœ… Zero Copy (Fast)</span>
                            <span style="font-size:0.8rem; color:#999;">2 Copies, 2 Context Switches</span>
                        </div>
                        <div class="zc-stage">
                            <div class="zc-container-inner">
                                <!-- Nodes -->
                                <div class="zc-node" style="left:0px; top:40px; background:#795548;">Disk</div>
                                <div class="zc-node" style="left:150px; top:40px; width:200px; background:#ff9800;">Kernel (Page Cache)</div>
                                <div class="zc-node" style="left:480px; top:40px; background:#2196f3;">NIC</div>

                                <!-- Arrows -->
                                <div class="zc-arrow arrow-dma" style="left:80px; width:70px; top:70px;">
                                    <div class="zc-label-sm" style="color:#2196f3">DMA</div>
                                </div>

                                <div class="zc-arrow arrow-dma" style="left:350px; width:130px; top:70px;">
                                    <div class="zc-label-sm" style="color:#2196f3">DMA (SG)</div>
                                </div>

                                <div class="zc-packet" id="pkt-zc"></div>
                            </div>
                        </div>
                        <button class="btn-success" style="width:100%; margin-top:5px;" onclick="playAnim('zc')">â–¶ï¸ Play Zero Copy Animation</button>
                    </div>

                    <div class="concept-box">
                        <h3 style="color:#4caf50">2. Sequential I/O (é¡ºåºå†™)</h3>
                        <p>Kafka å¼ºåˆ¶å°†æ¶ˆæ¯è¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶æœ«å°¾ï¼ˆAppend Onlyï¼‰ï¼Œåˆ©ç”¨ç£ç›˜é¡ºåºè¯»å†™æ€§èƒ½ï¼ˆæ¥è¿‘å†…å­˜ï¼‰ï¼Œé¿å…éšæœºå¯»å€ã€‚</p>
                    </div>

                    <div class="concept-box">
                        <h3 style="color:#ff9800">3. Page Cache (é¡µç¼“å­˜)</h3>
                        <p>Kafka å¹¶ä¸æ˜¾å¼ç®¡ç†å†…å­˜ï¼Œè€Œæ˜¯åˆ©ç”¨ OS çš„ <b>Page Cache</b> (æ–‡ä»¶ç³»ç»Ÿç¼“å­˜)ã€‚</p>
                        <ul style="margin:5px 0; padding-left:20px; font-size:0.9rem; color:#555;">
                            <li><b>ä¼˜åŠ¿ 1:</b> é¿å… JVM GC (åƒåœ¾å›æ”¶) çš„å·¨å¤§å¼€é”€ã€‚</li>
                            <li><b>ä¼˜åŠ¿ 2:</b> Broker é‡å¯åï¼ŒOS ç¼“å­˜ä¾ç„¶å­˜åœ¨ (çƒ­ç¼“å­˜)ã€‚</li>
                            <li><b>æœºåˆ¶:</b> å†™å…¥æ—¶ç›´æ¥å†™åˆ° Page Cache (å†…å­˜) å³è¿”å›ï¼Œç”± OS å¼‚æ­¥åˆ·ç›˜ (Flush)ã€‚</li>
                        </ul>
                    </div>

                    <div class="concept-box">
                        <h3 style="color:#9c27b0">4. Batching (æ‰¹é‡å‘é€)</h3>
                        <p>Producer ä¸ºäº†æé«˜ååé‡ï¼Œä¼šå°†å‘å¾€åŒä¸€åˆ†åŒºçš„å¤šæ¡æ¶ˆæ¯æ‰“åŒ…æˆä¸€ä¸ª <b>Batch</b> ä¸€æ¬¡æ€§å‘é€ã€‚</p>
                        <div style="background:#f9f9f9; padding:10px; border-radius:4px; margin-top:5px;">
                            <div style="font-size:0.85rem; font-weight:bold; margin-bottom:5px;">å…³é”®å‚æ•° (è§¦å‘æ¡ä»¶):</div>
                            <code style="color:#d32f2f">batch.size</code>: æ‰¹æ¬¡å¤§å° (å¦‚ 16KB)ã€‚<br>
                            <code style="color:#d32f2f">linger.ms</code>: æœ€é•¿ç­‰å¾…æ—¶é—´ (å¦‚ 5ms)ã€‚<br>
                            <div style="font-size:0.8rem; color:#666; margin-top:5px;">
                                <i>* åªè¦æ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼ŒBatch å°±ä¼šè¢«å‘é€ã€‚</i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configs -->
                <div class="kb-section">
                    <h2>Financial Best Practices</h2>
                    
                    <div class="concept-box" style="border-left:4px solid #2196f3;">
                        <h3>Exactly Once Semantics</h3>
                        <p>ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢ã€ä¸é‡ã€‚</p>
                        <div style="margin-top:10px;">
                            <div style="margin-bottom:5px;"><b>Producer:</b></div>
                            <span class="tag tag-config">enable.idempotence=true</span>
                            <span class="tag tag-config">transactional.id=tx-1</span>
                        </div>
                        <div style="margin-top:10px;">
                            <div style="margin-bottom:5px;"><b>Consumer:</b></div>
                            <span class="tag tag-config">isolation.level=read_committed</span>
                        </div>
                    </div>

                    <div class="concept-box" style="border-left:4px solid #f44336;">
                        <h3>High Availability (HA)</h3>
                        <p>é˜²æ­¢å•ç‚¹æ•…éšœå¯¼è‡´çš„æ•°æ®ä¸¢å¤±ã€‚</p>
                        <ul style="padding-left:20px; margin:10px 0;">
                            <li><span class="tag tag-config">acks=all</span> (Wait for ISR)</li>
                            <li><span class="tag tag-config">min.insync.replicas=2</span> (Quorum)</li>
                            <li><span class="tag tag-config">unclean.leader.election=false</span> (Safety > Availability)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: INTERVIEW PREP -->
        <div id="view-interview" class="view-section">
            <div style="max-width:1000px; margin:0 auto;">
                <h2 style="text-align:center; margin-bottom:30px; color:#333;">ğŸ”¥ High Frequency Interview Questions</h2>
                
                <div class="interview-grid">
                    <!-- Scenarios -->
                    <div class="qa-card">
                        <div class="qa-q">Q: Kafka å…¸å‹åº”ç”¨åœºæ™¯ä¸é…ç½®ï¼Ÿ</div>
                        <div class="qa-a">
                            1. <b>æ—¥å¿—æ”¶é›† (Log Aggregation)</b>: 
                               <br>- <i>ç‰¹ç‚¹</i>: é«˜ååï¼Œå…è®¸å°‘é‡ä¸¢å¤±ã€‚
                               <br>- <i>é…ç½®</i>: <code>acks=0/1</code>, <code>batch.size</code>å¤§, <code>linger.ms=5-100</code>, <code>compression.type=lz4</code>ã€‚
                            <br><br>
                            2. <b>æ¶ˆæ¯ç³»ç»Ÿ (Messaging)</b>: 
                               <br>- <i>ç‰¹ç‚¹</i>: å‰Šå³°å¡«è°·ï¼Œé«˜å¯é ã€‚
                               <br>- <i>é…ç½®</i>: <code>acks=all</code>, <code>min.insync.replicas=2</code>, <code>enable.idempotence=true</code>ã€‚
                            <br><br>
                            3. <b>æµå¼å¤„ç† (Stream Processing)</b>: 
                               <br>- <i>ç‰¹ç‚¹</i>: ä½å»¶è¿Ÿï¼ŒExactly Onceã€‚
                               <br>- <i>é…ç½®</i>: <code>isolation.level=read_committed</code> (é…åˆäº‹åŠ¡)ã€‚
                        </div>
                    </div>

                    <!-- Message Semantics -->
                    <div class="qa-card">
                        <div class="qa-q">Q: æ¶ˆæ¯è¯­ä¹‰ (Semantics) æœ‰å“ªäº›ï¼Ÿ</div>
                        <div class="qa-a">
                            1. <b>At Most Once</b>: æ¶ˆæ¯å¯èƒ½ä¸¢ï¼Œä½†ç»ä¸é‡ (å‘å®Œå³å¿˜)ã€‚<br>
                            2. <b>At Least Once</b>: æ¶ˆæ¯ç»ä¸ä¸¢ï¼Œä½†å¯èƒ½é‡ (é»˜è®¤)ã€‚<br>
                            3. <b>Exactly Once</b>: æ¶ˆæ¯ä¸ä¸¢ä¹Ÿä¸é‡ (å¹‚ç­‰æ€§ + äº‹åŠ¡)ã€‚
                        </div>
                    </div>

                    <!-- Data Loss Prevention -->
                    <div class="qa-card">
                        <div class="qa-q">Q: å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼Ÿ</div>
                        <div class="qa-a">
                            <b>Producer</b>: <code>acks=all</code>, <code>retries=MAX</code><br>
                            <b>Broker</b>: <code>min.insync.replicas > 1</code>, <code>unclean.leader.election=false</code><br>
                            <b>Consumer</b>: å…³é—­è‡ªåŠ¨æäº¤ (<code>enable.auto.commit=false</code>)ï¼Œå¤„ç†å®Œä¸šåŠ¡å†æ‰‹åŠ¨æäº¤ Offsetã€‚
                        </div>
                    </div>

                    <!-- Duplication -->
                    <div class="qa-card">
                        <div class="qa-q">Q: å¦‚ä½•é˜²æ­¢æ¶ˆæ¯é‡å¤ (Duplicate)ï¼Ÿ</div>
                        <div class="qa-a">
                            <b>1. é˜²æ­¢å‘é€é‡å¤ (Producer):</b>
                            <br>- å¼€å¯ <b>å¹‚ç­‰æ€§</b>: <code>enable.idempotence=true</code> (é»˜è®¤å¼€å¯)ã€‚
                            <br>- åŸç†: Broker ç»´æŠ¤ <code>(PID, SequenceNumber)</code>ï¼Œé‡å¤å‘é€çš„ SeqNum ä¼šè¢«æ‹’ç»ã€‚
                            <br><br>
                            <b>2. é˜²æ­¢æ¶ˆè´¹é‡å¤ (Consumer):</b>
                            <br>- <b>åŸå› </b>: æ¶ˆè´¹å Offset æäº¤å¤±è´¥ (å®•æœº/Rebalance)ã€‚
                            <br>- <b>è§£å†³</b>: æ¶ˆè´¹é€»è¾‘éœ€<b>å¹‚ç­‰</b>ã€‚
                            <br>&nbsp;&nbsp;a. DB å”¯ä¸€é”® (Insert Ignore / Upsert)ã€‚
                            <br>&nbsp;&nbsp;b. Redis è®°å½•å·²å¤„ç† MessageIDã€‚
                        </div>
                    </div>

                    <!-- ACKS -->
                    <div class="qa-card">
                        <div class="qa-q">Q: acks å‚æ•°è¯¦è§£ï¼Ÿ</div>
                        <div class="qa-a">
                            <code>acks=0</code>: ä¸ç­‰ Broker ç¡®è®¤ï¼Œæœ€å¿«ä½†æ˜“ä¸¢ã€‚<br>
                            <code>acks=1</code>: Leader å†™å…¥å³ç¡®è®¤ (é»˜è®¤)ï¼ŒLeader æŒ‚å¯èƒ½ä¸¢ã€‚<br>
                            <code>acks=all (-1)</code>: ç­‰å¾…æ‰€æœ‰ ISR å‰¯æœ¬å†™å…¥æ‰ç¡®è®¤ï¼Œæœ€å®‰å…¨ã€‚
                        </div>
                    </div>

                    <!-- Lag -->
                    <div class="qa-card">
                        <div class="qa-q">Q: æ¶ˆæ¯ç§¯å‹ (Lag) æ€ä¹ˆå¤„ç†ï¼Ÿ</div>
                        <div class="qa-a">
                            1. <b>ä¸´æ—¶æ‰©å®¹</b>: æ–°å»º Topic (æ›´å¤šåˆ†åŒº)ï¼Œèµ·ä¸´æ—¶ Consumer æŠŠç§¯å‹æ•°æ®è½¬å‘è¿‡å»ï¼Œå†ç”¨æ›´å¤š Consumer æ¶ˆè´¹ã€‚<br>
                            2. <b>å¢åŠ å¹¶å‘</b>: å¢åŠ  Consumer çº¿ç¨‹æ•°æˆ–å®ä¾‹æ•°ï¼ˆå—é™äºåˆ†åŒºæ•°ï¼‰ã€‚
                        </div>
                    </div>

                    <!-- Performance -->
                    <div class="qa-card">
                        <div class="qa-q">Q: Kafka ä¸ºä»€ä¹ˆå¿«ï¼Ÿ</div>
                        <div class="qa-a">
                            1. <b>é¡ºåºå†™</b> (Sequential I/O)<br>
                            2. <b>é›¶æ‹·è´</b> (Zero Copy / sendfile)<br>
                            3. <b>Page Cache</b> (OS æ–‡ä»¶ç¼“å­˜)<br>
                            4. <b>æ‰¹é‡å‘é€</b> (Batching)
                        </div>
                    </div>

                    <!-- ISR -->
                    <div class="qa-card">
                        <div class="qa-q">Q: ISR æ˜¯ä»€ä¹ˆï¼Ÿ</div>
                        <div class="qa-a">
                            <b>In-Sync Replicas</b>ã€‚åªæœ‰è·Ÿä¸Š Leader çš„å‰¯æœ¬æ‰åœ¨ ISR ä¸­ã€‚åªæœ‰ ISR é‡Œçš„å‰¯æœ¬æ‰æœ‰èµ„æ ¼è¢«é€‰ä¸ºæ–° Leader (é™¤é unclean=true)ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Tab Switching ---
        function switchTab(tabId) {
            // Update Nav
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update View
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
        }

        // --- Animation Logic ---
        function playAnim(type) {
            const id = type === 'std' ? 'pkt-std' : 'pkt-zc';
            const pkt = document.getElementById(id);
            
            pkt.style.display = 'block';
            pkt.style.animation = 'none';
            pkt.offsetHeight; 
            
            if(type === 'std') {
                pkt.style.animation = 'move-std 2s linear forwards';
            } else {
                pkt.style.animation = 'move-zc 1s linear forwards';
            }
        }

        // --- Kafka Simulation Logic (Preserved) ---
        const PARTITION_COUNT = 4;
        let partitions = []; 
        let consumers = []; 
        let brokers = { 1: true, 2: true }; 
        let consumerIdCounter = 1;
        let msgCounter = 1;
        let lagMode = false;

        // Init Data
        for(let i=0; i<PARTITION_COUNT; i++) {
            const leader = (i % 2) + 1;
            const replica = leader === 1 ? 2 : 1;
            partitions.push({ id: i, messages: [], assignedTo: null, leader: leader, replicas: [leader, replica] });
        }

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `> ${msg}`;
            const console = document.getElementById('log');
            console.appendChild(div);
            console.scrollTop = console.scrollHeight;
        }

        function render() {
            // 1. Render Brokers & Partitions
            const leaderCounts = { 1: 0, 2: 0 };
            partitions.forEach(p => { if (brokers[p.leader]) leaderCounts[p.leader]++; });

            for(let bId=1; bId<=2; bId++) {
                const header = document.getElementById(`broker-header-${bId}`);
                const body = document.getElementById(`broker-partitions-${bId}`);
                body.innerHTML = '';

                if(brokers[bId]) {
                    header.innerText = `Broker ${bId} (Active)`;
                    header.style.background = '#eee';
                    header.style.color = '#333';
                    if (leaderCounts[bId] === partitions.length && partitions.length > 0) {
                        header.innerHTML += ' <span style="color:#ff9800">âš ï¸ 100% Load</span>';
                    }
                } else {
                    header.innerText = `Broker ${bId} (DOWN)`;
                    header.style.background = '#f44336';
                    header.style.color = 'white';
                }
            }

            partitions.forEach(p => {
                // Flash effect logic
                if(p.flash && !p.flashScheduled) {
                    p.flashScheduled = true;
                    setTimeout(() => { p.flash = false; p.flashScheduled = false; render(); }, 1000);
                }

                p.replicas.forEach(rId => {
                    const container = document.getElementById(`broker-partitions-${rId}`);
                    if(!container) return;
                    
                    const isLeader = (rId === p.leader);
                    const div = document.createElement('div');
                    div.className = `partition-replica ${isLeader ? 'leader' : 'follower'}`;
                    if(p.flash) div.style.background = '#fff9c4';

                    const msgsHtml = p.messages.map(m => `<div class="msg-dot" style="background:${m.color}"></div>`).join('');
                    const lagCount = p.messages.length;

                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <b>P${p.id}</b>
                            <span style="font-size:0.7rem; background:${isLeader?'#4caf50':'#e0e0e0'}; color:${isLeader?'white':'#666'}; padding:1px 4px; border-radius:3px;">${isLeader?'L':'F'}</span>
                        </div>
                        <div class="msg-queue">${msgsHtml}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px;">
                             ${isLeader && p.assignedTo ? `<span style="font-size:0.7rem; color:#2196f3;">By ${p.assignedTo}</span>` : '<span></span>'}
                             ${lagCount > 0 ? `<span style="font-size:0.7rem; color:${lagCount>5?'red':'#999'}; font-weight:bold;">Lag: ${lagCount}</span>` : ''}
                        </div>
                    `;
                    container.appendChild(div);
                });
            });

            // 2. Render Consumers
            const cContainer = document.getElementById('consumers');
            cContainer.innerHTML = '';
            consumers.forEach(c => {
                const div = document.createElement('div');
                div.className = 'consumer-circle';
                if (c.assignedPartitions.length === 0) div.style.background = '#bdbdbd';
                
                div.innerHTML = `
                    <div>C${c.id}</div>
                    <div style="font-size:0.6rem;">${c.assignedPartitions.map(p=>'P'+p).join(',')}</div>
                `;
                cContainer.appendChild(div);
            });
        }

        // --- Actions ---
        function toggleBroker(id) {
            brokers[id] = !brokers[id];
            log(`Broker ${id} is now ${brokers[id]?'Active':'DOWN'}`);
            
            if(!brokers[id]) {
                // Failover logic
                partitions.forEach(p => {
                    if(p.leader === id) {
                        const newLeader = p.replicas.find(r => r !== id && brokers[r]);
                        if(newLeader) {
                            p.leader = newLeader;
                            p.flash = true;
                            log(`[Failover] P${p.id} Leader -> B${newLeader}`);
                        } else {
                            log(`[Failover] P${p.id} Offline!`);
                        }
                    }
                });
            }
            render();
        }

        function triggerPreferredLeaderElection() {
            log("Rebalancing Leaders...");
            partitions.forEach(p => {
                const pref = p.replicas[0];
                if(brokers[pref] && p.leader !== pref) {
                    p.leader = pref;
                    p.flash = true;
                }
            });
            render();
        }

        function produceMessage() {
            const pId = (msgCounter - 1) % PARTITION_COUNT;
            const p = partitions[pId];
            if(!brokers[p.leader]) { log(`Produce P${pId} Failed (Leader Down)`); return; }
            
            p.messages.push({ id: msgCounter++, color: '#ff9800' });
            if(p.messages.length > 10) p.messages.shift();
            log(`Produced Msg to P${pId}`);
            consume(pId);
            render();
        }

        function produceKeyedMessage() {
            const key = prompt("Enter Key:", "user1");
            if(!key) return;
            let hash = 0;
            for(let i=0; i<key.length; i++) hash += key.charCodeAt(i);
            const pId = hash % PARTITION_COUNT;
            const p = partitions[pId];
            
            if(!brokers[p.leader]) { log(`Produce P${pId} Failed`); return; }
            
            const color = '#' + Math.floor(Math.abs(Math.sin(hash) * 16777215)).toString(16);
            p.messages.push({ id: msgCounter++, color: color });
            if(p.messages.length > 10) p.messages.shift();
            log(`Produced Keyed('${key}') to P${pId}`);
            consume(pId);
            render();
        }

        function consume(pId) {
            const p = partitions[pId];
            if(p.assignedTo) {
                setTimeout(() => {
                    if(p.messages.length > 0) { p.messages.shift(); render(); }
                }, lagMode ? 3000 : 1000);
            }
        }

        function addConsumer() {
            consumers.push({ id: consumerIdCounter++, assignedPartitions: [] });
            rebalance();
        }
        function removeConsumer() {
            consumers.pop();
            rebalance();
        }

        function rebalance() {
            log("Rebalancing Group...");
            partitions.forEach(p => p.assignedTo = null);
            consumers.forEach(c => c.assignedPartitions = []);
            
            if(consumers.length === 0) { render(); return; }
            
            const active = Math.min(partitions.length, consumers.length);
            const size = Math.floor(partitions.length / active);
            let rem = partitions.length % active;
            let pIdx = 0;
            
            for(let i=0; i<active; i++) {
                let mySize = size + (rem-- > 0 ? 1 : 0);
                for(let j=0; j<mySize; j++) {
                    const p = partitions[pIdx++];
                    p.assignedTo = `C${consumers[i].id}`;
                    consumers[i].assignedPartitions.push(p.id);
                }
            }
            render();
        }

        // Scenarios
        function scenarioOrdering() {
            log("Scenario: Ordering (Keyed)");
            let c = 0;
            const i = setInterval(() => {
                // Simulate keyed produce
                const pId = 0; // Force P0
                const p = partitions[pId];
                if(brokers[p.leader]) {
                    p.messages.push({id:msgCounter++, color:'#9c27b0'});
                    if(p.messages.length>10) p.messages.shift();
                    consume(pId);
                    render();
                }
                if(++c >= 5) clearInterval(i);
            }, 400);
        }
        function scenarioIdle() { while(consumers.length < 6) addConsumer(); }
        function scenarioLag() { 
            lagMode = true; 
            log("âš ï¸ Lag Mode ON: High Produce Rate, Slow Consume Rate"); 
            
            // Burst produce
            let count = 0;
            const burst = setInterval(() => {
                produceMessage();
                count++;
                if(count > 15) clearInterval(burst);
            }, 200); // Fast produce

            setTimeout(() => { 
                lagMode = false; 
                log("âœ… Lag Mode OFF: Resuming normal speed"); 
            }, 8000);
        }
        function scenarioFailover() {
            log("Scenario: Failover");
            brokers[1]=true; brokers[2]=true;
            render();
            setTimeout(() => toggleBroker(1), 1000);
            setTimeout(() => toggleBroker(1), 4000);
            setTimeout(() => triggerPreferredLeaderElection(), 6000);
        }

        // Start
        addConsumer();
        render();

    </script>
</body>
</html>