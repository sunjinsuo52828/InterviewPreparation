<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloom Filter Visualization</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        h1 { color: #673ab7; margin-bottom: 10px; }
        
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 900px; position: relative; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        input { padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; width: 200px; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-add { background: #2e7d32; color: white; }
        .btn-check { background: #1565c0; color: white; }
        .btn-reset { background: #616161; color: white; }
        .btn-theory { background: #e65100; color: white; }

        .bit-array-container { margin: 60px 0 40px 0; overflow-x: auto; padding-bottom: 10px; position: relative; }
        .bit-array { display: flex; gap: 4px; justify-content: center; min-width: max-content; }
        .bit { 
            width: 30px; height: 40px; border: 1px solid #ccc; border-radius: 4px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.8rem; background: #f8f9fa; transition: all 0.3s; position: relative; z-index: 2;
        }
        .bit.active { background: #4caf50; color: white; border-color: #388e3c; font-weight: bold; }
        .bit-index { font-size: 0.6rem; color: #999; margin-top: 2px; }
        .bit-val { font-size: 1rem; }
        
        .bit.highlight { box-shadow: 0 0 15px #ff9800; border-color: #ff9800; transform: scale(1.2); z-index: 10; }
        .bit.check-pass { box-shadow: 0 0 15px #2196f3; border-color: #2196f3; }
        .bit.check-fail { box-shadow: 0 0 15px #f44336; border-color: #f44336; background: #ffebee; }

        .hash-functions { display: flex; justify-content: space-around; margin-bottom: 20px; position: relative; z-index: 2; }
        .hash-func { 
            background: #e3f2fd; padding: 15px; border-radius: 8px; border: 2px solid #90caf9; 
            width: 200px; text-align: center; position: relative; transition: all 0.3s;
        }
        .hash-func.active { background: #bbdefb; border-color: #1976d2; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hash-val { font-size: 1.5rem; font-weight: bold; color: #1565c0; margin-top: 5px; min-height: 35px; }

        .log-area { 
            background: #212121; color: #00e676; padding: 15px; border-radius: 8px; 
            font-family: 'Consolas', monospace; height: 150px; overflow-y: auto; margin-top: 20px; 
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-entry.error { color: #ff5252; }
        .log-entry.warn { color: #ffab40; }
        .log-entry.info { color: #40c4ff; }

        .verdict-box {
            margin: 20px 0; padding: 20px; border-radius: 8px; text-align: center; font-size: 1.5rem; font-weight: bold; display: none;
        }
        .verdict-yes { background: #e8f5e9; color: #2e7d32; border: 2px solid #2e7d32; }
        .verdict-no { background: #ffebee; color: #c62828; border: 2px solid #c62828; }

        .narrative {
            background: #e1f5fe; color: #01579b; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6; min-height: 60px; display: flex; align-items: center; border-left: 5px solid #0288d1;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
        }
        .close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #666;
        }
        .close-btn:hover { color: #d82c20; }

        /* SVG Overlay for connecting lines */
        #svg-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;
        }
        path {
            fill: none; stroke: #ff9800; stroke-width: 3; stroke-dasharray: 10; animation: dash 1s linear infinite;
            opacity: 0; transition: opacity 0.3s;
        }
        path.visible { opacity: 1; }
        @keyframes dash { to { stroke-dashoffset: -20; } }

    </style>
</head>
<body>
    <h1>Bloom Filter Visualization</h1>
    
    <div class="container">
        <svg id="svg-overlay"></svg>

        <div class="narrative" id="narrative">
            Welcome! Enter a string to see how a Bloom Filter uses a Bit Array to store it.
        </div>

        <div class="verdict-box" id="verdict"></div>

        <div class="controls">
            <input type="text" id="input-val" placeholder="Enter string (e.g. 'Apple')" onkeypress="if(event.key==='Enter') addVal()">
            <button class="btn-add" onclick="addVal()">Add</button>
            <button class="btn-check" onclick="checkVal()">Check</button>
            <button class="btn-reset" onclick="resetFilter()">Reset</button>
            <button class="btn-theory" onclick="openModal()">ðŸ¤” Deep Dive</button>
        </div>

        <div class="hash-functions">
            <div class="hash-func" id="h1-box">
                <div>Hash 1 (Mod 30)</div>
                <div class="hash-val" id="h1-val">-</div>
            </div>
            <div class="hash-func" id="h2-box">
                <div>Hash 2 (Mod 30)</div>
                <div class="hash-val" id="h2-val">-</div>
            </div>
            <div class="hash-func" id="h3-box">
                <div>Hash 3 (Mod 30)</div>
                <div class="hash-val" id="h3-val">-</div>
            </div>
        </div>

        <div class="bit-array-container">
            <div class="bit-array" id="bit-array">
                <!-- Bits generated by JS -->
            </div>
        </div>

        <div class="log-area" id="log">
            <div class="log-entry">> System Ready. Array Size: 30 bits. 3 Hash Functions.</div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="deep-dive-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('deep-dive-modal').style.display='none'">&times;</span>
            <h2 style="color:#673ab7; margin-top:0;">ðŸ“š Deep Dive: Bloom Filter</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color:#333;">1. Core Principle</h3>
                    <ul style="padding-left:20px; color:#555;">
                        <li><strong>Space Efficiency:</strong> Does not store data itself, only "fingerprints" (bits).</li>
                        <li><strong>Hash Functions:</strong> Uses $k$ hash functions to map data to $k$ positions in the bit array, setting them to 1.</li>
                        <li><strong>Query Logic:</strong> Check these $k$ positions. If <strong>ALL are 1</strong>, data <em>might</em> exist. If <strong>ANY is 0</strong>, data <em>definitely does not</em> exist.</li>
                    </ul>
                </div>
                <div>
                    <h3 style="color:#d32f2f;">2. False Positive</h3>
                    <ul style="padding-left:20px; color:#555;">
                        <li><strong>Why?</strong> Different data might hash to the same positions (Hash Collision).</li>
                        <li><strong>Conclusion:</strong> If it says "Exists", it might be wrong. If it says "Not Exists", it is always right.</li>
                        <li><strong>Mitigation:</strong> Increase bit array size ($m$) or adjust number of hash functions ($k$).</li>
                    </ul>
                </div>
                <div>
                    <h3 style="color:#1976d2;">3. Limitations</h3>
                    <ul style="padding-left:20px; color:#555;">
                        <li><strong>No Deletion:</strong> Resetting a bit to 0 might affect other data (since bits are shared).</li>
                        <li><strong>Solution:</strong> Counting Bloom Filter (stores counters instead of bits), but uses more space.</li>
                    </ul>
                </div>
                <div>
                    <h3 style="color:#f57c00;">4. Use Cases</h3>
                    <ul style="padding-left:20px; color:#555;">
                        <li><strong>Redis Cache Penetration:</strong> Block invalid keys before hitting DB.</li>
                        <li><strong>Web Crawler:</strong> Check if URL has already been crawled.</li>
                        <li><strong>Spam Filter:</strong> Check against blacklist.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ARRAY_SIZE = 30;
        const bitArray = new Array(ARRAY_SIZE).fill(0);
        let isAnimating = false;
        
        // Initialize UI
        const bitContainer = document.getElementById('bit-array');
        for(let i=0; i<ARRAY_SIZE; i++) {
            const div = document.createElement('div');
            div.className = 'bit';
            div.id = `bit-${i}`;
            div.innerHTML = `<span class="bit-val">0</span><span class="bit-index">${i}</span>`;
            bitContainer.appendChild(div);
        }

        function openModal() {
            document.getElementById('deep-dive-modal').style.display = 'flex';
        }

        function closeModal(e) {
            if (e.target.className === 'modal-overlay') {
                document.getElementById('deep-dive-modal').style.display = 'none';
            }
        }

        // Hash Functions
        function hash1(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash << 5) - hash + str.charCodeAt(i);
                hash |= 0; 
            }
            return Math.abs(hash) % ARRAY_SIZE;
        }

        function hash2(str) {
            let hash = 5381;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i); 
            }
            return Math.abs(hash) % ARRAY_SIZE;
        }

        function hash3(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash + str.charCodeAt(i) * (i + 1));
            }
            return Math.abs(hash) % ARRAY_SIZE;
        }

        function log(msg, type='info') {
            const consoleDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerText = `> ${msg}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function narrate(html) {
            document.getElementById('narrative').innerHTML = html;
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        function drawArrow(fromId, toId) {
            const svg = document.getElementById('svg-overlay');
            const fromEl = document.getElementById(fromId);
            const toEl = document.getElementById(toId);
            const container = document.querySelector('.container');

            if (!fromEl || !toEl || !container) return null;

            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();
            const contRect = container.getBoundingClientRect();

            const startX = fromRect.left + fromRect.width / 2 - contRect.left;
            const startY = fromRect.bottom - contRect.top;
            const endX = toRect.left + toRect.width / 2 - contRect.left;
            const endY = toRect.top - contRect.top;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            // Bezier curve for smooth connector
            const d = `M ${startX} ${startY} C ${startX} ${startY + 50}, ${endX} ${endY - 50}, ${endX} ${endY}`;
            path.setAttribute("d", d);
            path.classList.add("visible");
            
            svg.appendChild(path);
            return path;
        }

        async function runHashAnimation(hNum, idx, type) {
            const box = document.getElementById(`h${hNum}-box`);
            const valBox = document.getElementById(`h${hNum}-val`);
            const bit = document.getElementById(`bit-${idx}`);

            box.classList.add('active');
            valBox.innerText = idx;
            await wait(300);

            // Draw Arrow
            const arrow = drawArrow(`h${hNum}-box`, `bit-${idx}`);

            // Draw line (Simplified: just highlight bit)
            bit.classList.add('highlight');
            await wait(600); // Increased wait time to see the arrow

            if (type === 'set') {
                bitArray[idx] = 1;
                bit.querySelector('.bit-val').innerText = '1';
                bit.classList.add('active');
            } else if (type === 'check') {
                if (bitArray[idx] === 1) {
                    bit.classList.add('check-pass');
                } else {
                    bit.classList.add('check-fail');
                }
            }

            await wait(300);
            box.classList.remove('active');
            bit.classList.remove('highlight');
            
            // Remove Arrow
            if (arrow) arrow.remove();

            if(type === 'check') {
                setTimeout(() => {
                    bit.classList.remove('check-pass', 'check-fail');
                }, 1000);
            }
        }

        async function addVal() {
            if(isAnimating) return;
            const input = document.getElementById('input-val');
            const val = input.value.trim();
            if(!val) return;

            isAnimating = true;
            clearVerdict();
            narrate(`Adding "<strong>${val}</strong>"... We need to set 3 bits to 1.`);
            log(`--------------------------------`);
            log(`Adding "${val}"...`, 'info');
            
            const h1 = hash1(val);
            const h2 = hash2(val);
            const h3 = hash3(val);

            narrate(`Hash 1 maps "${val}" to index <strong>${h1}</strong>.`);
            await runHashAnimation(1, h1, 'set');
            
            narrate(`Hash 2 maps "${val}" to index <strong>${h2}</strong>.`);
            await runHashAnimation(2, h2, 'set');
            
            narrate(`Hash 3 maps "${val}" to index <strong>${h3}</strong>.`);
            await runHashAnimation(3, h3, 'set');

            narrate(`Done! "${val}" is stored (bits ${h1}, ${h2}, ${h3}).`);
            log(`> Success: "${val}" added.`, 'info');
            input.value = '';
            isAnimating = false;
        }

        async function checkVal() {
            if(isAnimating) return;
            const input = document.getElementById('input-val');
            const val = input.value.trim();
            if(!val) return;

            isAnimating = true;
            clearVerdict();
            narrate(`Checking "<strong>${val}</strong>"... We need to check if corresponding bits are 1.`);
            log(`--------------------------------`);
            log(`Checking "${val}"...`, 'info');

            const h1 = hash1(val);
            const h2 = hash2(val);
            const h3 = hash3(val);

            // Check 1
            narrate(`Hash 1 points to index <strong>${h1}</strong>. Is it 1?`);
            await runHashAnimation(1, h1, 'check');
            if(bitArray[h1] === 0) {
                showVerdict(false, val);
                narrate(`Bit ${h1} is 0. So "${val}" <strong>definitely does not</strong> exist.`);
                log(`> Bit ${h1} is 0. STOP.`, 'error');
                log(`> Result: "${val}" is DEFINITELY NOT in set.`, 'error');
                isAnimating = false;
                return;
            }

            // Check 2
            narrate(`Bit ${h1} is 1 (Match). Checking Hash 2 (Index <strong>${h2}</strong>)...`);
            await runHashAnimation(2, h2, 'check');
            if(bitArray[h2] === 0) {
                showVerdict(false, val);
                narrate(`Bit ${h2} is 0. So "${val}" <strong>definitely does not</strong> exist.`);
                log(`> Bit ${h2} is 0. STOP.`, 'error');
                log(`> Result: "${val}" is DEFINITELY NOT in set.`, 'error');
                isAnimating = false;
                return;
            }

            // Check 3
            narrate(`Bit ${h2} is 1 (Match). Checking Hash 3 (Index <strong>${h3}</strong>)...`);
            await runHashAnimation(3, h3, 'check');
            if(bitArray[h3] === 0) {
                showVerdict(false, val);
                narrate(`Bit ${h3} is 0. So "${val}" <strong>definitely does not</strong> exist.`);
                log(`> Bit ${h3} is 0. STOP.`, 'error');
                log(`> Result: "${val}" is DEFINITELY NOT in set.`, 'error');
                isAnimating = false;
                return;
            }

            showVerdict(true, val);
            narrate(`All bits (${h1}, ${h2}, ${h3}) are 1. "${val}" <strong>might</strong> exist.`);
            log(`> All bits [${h1}, ${h2}, ${h3}] are 1.`, 'warn');
            log(`> Result: "${val}" is POSSIBLY in set (False Positive risk).`, 'warn');
            isAnimating = false;
        }

        function showVerdict(isPositive, val) {
            const el = document.getElementById('verdict');
            el.style.display = 'block';
            if(isPositive) {
                el.className = 'verdict-box verdict-yes';
                el.innerHTML = `POSSIBLY YES<br><span style="font-size:0.9rem; font-weight:normal">(All bits match)</span>`;
            } else {
                el.className = 'verdict-box verdict-no';
                el.innerHTML = `DEFINITELY NO<br><span style="font-size:0.9rem; font-weight:normal">(Found 0 bit)</span>`;
            }
        }

        function clearVerdict() {
            document.getElementById('verdict').style.display = 'none';
        }

        function resetFilter() {
            bitArray.fill(0);
            document.querySelectorAll('.bit').forEach(b => {
                b.classList.remove('active', 'check-pass', 'check-fail');
                b.querySelector('.bit-val').innerText = '0';
            });
            document.getElementById('h1-val').innerText = '-';
            document.getElementById('h2-val').innerText = '-';
            document.getElementById('h3-val').innerText = '-';
            clearVerdict();
            log('Filter Reset.', 'info');
            narrate('Filter cleared.');
        }

    </script>
</body>
</html>