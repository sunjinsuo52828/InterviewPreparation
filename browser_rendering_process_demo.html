<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Rendering Process: URL to Pixel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #333; }
        
        .container { width: 100%; max-width: 1200px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Address Bar */
        .browser-bar { 
            background: #e0e0e0; padding: 10px; border-radius: 8px 8px 0 0; display: flex; gap: 10px; align-items: center; margin-bottom: 20px;
        }
        .url-input { flex: 1; padding: 8px; border-radius: 20px; border: 1px solid #ccc; padding-left: 15px; font-family: monospace; }
        .btn-go { background: #2196f3; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-go:disabled { background: #ccc; }

        /* Pipeline */
        .pipeline-container { position: relative; padding-bottom: 40px; margin-bottom: 20px; }
        .pipeline { display: flex; justify-content: space-between; position: relative; z-index: 2; }
        .stage { 
            width: 14%; background: #fafafa; border: 2px solid #ddd; border-radius: 6px; padding: 10px 5px; 
            display: flex; flex-direction: column; align-items: center; transition: all 0.3s; opacity: 0.6;
            position: relative; min-height: 100px;
        }
        .stage.active { border-color: #2196f3; background: #e3f2fd; opacity: 1; transform: scale(1.1); box-shadow: 0 4px 15px rgba(33,150,243,0.3); z-index: 10; }
        
        /* Connecting Line */
        .pipeline-line { 
            position: absolute; top: 50%; left: 0; width: 100%; height: 4px; background: #e0e0e0; z-index: 1; transform: translateY(-50%); 
        }
        .pipeline-progress {
            position: absolute; top: 50%; left: 0; height: 4px; background: #2196f3; z-index: 1; transform: translateY(-50%); width: 0%; transition: width 0.5s linear;
        }

        .stage-icon { font-size: 1.8rem; margin-bottom: 5px; }
        .stage-name { font-weight: bold; font-size: 0.85rem; text-align: center; }
        .stage-detail { font-size: 0.7rem; color: #666; text-align: center; margin-top: 5px; }

        /* Visualization Area */
        .visual-area { 
            height: 300px; background: #2d2d2d; border-radius: 8px; margin-top: 20px; position: relative; overflow: hidden; 
            display: flex; align-items: center; justify-content: center; color: #ccc; font-family: monospace;
        }
        
        /* DOM/CSSOM Nodes */
        .tree-node { 
            border: 2px solid #fff; padding: 5px 10px; border-radius: 4px; margin: 5px; display: inline-block; 
            background: #444; color: white; font-size: 0.8rem; transition: all 0.5s;
        }
        .tree-node.dom { border-color: #ff9800; }
        .tree-node.cssom { border-color: #2196f3; }
        .tree-node.render { border-color: #4caf50; background: #1b5e20; }

        /* Optimization Toggles */
        .opt-panel { margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
        .opt-title { font-weight: bold; color: #e65100; margin-bottom: 10px; }
        .opt-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .opt-section { display: flex; flex-direction: column; gap: 8px; padding: 10px; border-radius: 6px; }
        .opt-section.optimize { background: #e8f5e9; border: 1px solid #c8e6c9; }
        .opt-section.blocking { background: #ffebee; border: 1px solid #ffcdd2; }
        .opt-section-title { font-size: 0.75rem; font-weight: bold; color: #666; margin-bottom: 5px; }
        .opt-check { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .opt-check:hover { background: rgba(0,0,0,0.05); }
        .opt-check input:checked + span { font-weight: bold; }
        .opt-check.disabled { opacity: 0.5; pointer-events: none; }
        .opt-hint { font-size: 0.75rem; color: #888; margin-top: 5px; font-style: italic; }
        .opt-status { margin-top: 10px; padding: 8px; background: #fff; border-radius: 4px; font-size: 0.85rem; border-left: 3px solid #2196f3; }

        /* Performance Metrics */
        .metrics-panel { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; 
        }
        .metric-card { background: #e8f5e9; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #c8e6c9; }
        .metric-val { font-size: 1.5rem; font-weight: bold; color: #2e7d32; }
        .metric-label { font-size: 0.8rem; color: #555; }

        /* Interview Corner */
        .interview-panel { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .qa-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #673ab7; }
        .qa-q { font-weight: bold; color: #333; margin-bottom: 10px; }
        .qa-a { font-size: 0.9rem; color: #555; line-height: 1.5; }

        /* Comparison Table */
        .compare-section { margin-top: 30px; }
        .compare-title { font-size: 1.2rem; font-weight: bold; color: #1976d2; margin-bottom: 15px; border-bottom: 2px solid #1976d2; padding-bottom: 5px; }
        .compare-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .compare-table th { background: #e3f2fd; padding: 12px; text-align: left; border: 1px solid #bbdefb; }
        .compare-table td { padding: 10px; border: 1px solid #e0e0e0; vertical-align: top; }
        .compare-table tr:nth-child(even) { background: #fafafa; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin: 2px; }
        .tag-green { background: #c8e6c9; color: #2e7d32; }
        .tag-red { background: #ffcdd2; color: #c62828; }
        .tag-blue { background: #bbdefb; color: #1565c0; }
        .tag-orange { background: #ffe0b2; color: #e65100; }

        /* Process Architecture */
        .arch-section { margin-top: 30px; background: #f5f5f5; padding: 20px; border-radius: 8px; }
        .arch-title { font-size: 1.2rem; font-weight: bold; color: #424242; margin-bottom: 15px; }
        .arch-diagram { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .arch-box { background: white; border: 2px solid #9e9e9e; border-radius: 8px; padding: 15px; min-width: 150px; text-align: center; }
        .arch-box.browser { border-color: #2196f3; background: #e3f2fd; }
        .arch-box.renderer { border-color: #4caf50; background: #e8f5e9; }
        .arch-box.gpu { border-color: #ff9800; background: #fff3e0; }
        .arch-box.network { border-color: #9c27b0; background: #f3e5f5; }
        .arch-box-title { font-weight: bold; margin-bottom: 8px; }
        .arch-box-detail { font-size: 0.8rem; color: #666; }

        /* Tips Section */
        .tips-section { margin-top: 30px; }
        .tips-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .tip-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; }
        .tip-card.perf { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .tip-card.avoid { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .tip-title { font-weight: bold; margin-bottom: 8px; font-size: 1rem; }
        .tip-content { font-size: 0.85rem; opacity: 0.95; }
        .tip-code { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; margin-top: 8px; font-family: monospace; font-size: 0.8rem; }

        /* Animation Classes */
        .packet { position: absolute; width: 10px; height: 10px; background: yellow; border-radius: 50%; }
        .pixel { width: 5px; height: 5px; background: white; position: absolute; opacity: 0; }

        /* Log Panel */
        .log-panel { 
            background: #1e1e1e; border-radius: 8px; padding: 15px; margin-top: 20px; 
            font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; 
            max-height: 200px; overflow-y: auto; 
        }
        .log-title { color: #4ec9b0; font-weight: bold; margin-bottom: 10px; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #333; display: flex; gap: 10px; }
        .log-time { color: #569cd6; min-width: 60px; }
        .log-stage { color: #dcdcaa; min-width: 100px; }
        .log-msg { color: #ce9178; }
        .log-entry.network .log-stage { color: #4fc1ff; }
        .log-entry.parse .log-stage { color: #ff9800; }
        .log-entry.render .log-stage { color: #4caf50; }
        .log-entry.layout .log-stage { color: #9c27b0; }
        .log-entry.paint .log-stage { color: #f44336; }
        .log-entry.composite .log-stage { color: #2196f3; }

    </style>
</head>
<body>

    <h1>Browser Rendering Process: URL to Pixel</h1>

    <div class="container">
        <div class="browser-bar">
            <div style="font-weight:bold; color:#555;">Chrome</div>
            <input type="text" class="url-input" value="https://www.example.com" readonly>
            <button class="btn-go" onclick="startProcess()" id="btnStart">Go</button>
            <button class="btn-go" onclick="reset()" style="background:#757575; margin-left:5px;">Reset</button>
        </div>

        <div class="pipeline-container">
            <div class="pipeline-line"></div>
            <div class="pipeline-progress" id="progress-bar"></div>
            <div class="pipeline">
                <div class="stage" id="st-dns">
                    <div class="stage-icon">ğŸŒ</div>
                    <div class="stage-name">1. Network</div>
                    <div class="stage-detail">DNS, TCP, HTTP</div>
                </div>
                <div class="stage" id="st-parse">
                    <div class="stage-icon">ğŸ“„</div>
                    <div class="stage-name">2. Parsing</div>
                    <div class="stage-detail">HTML -> DOM<br>CSS -> CSSOM</div>
                </div>
                <div class="stage" id="st-render">
                    <div class="stage-icon">ğŸŒ³</div>
                    <div class="stage-name">3. Render Tree</div>
                    <div class="stage-detail">Visible Nodes</div>
                </div>
                <div class="stage" id="st-layout">
                    <div class="stage-icon">ğŸ“</div>
                    <div class="stage-name">4. Layout</div>
                    <div class="stage-detail">Geometry (Reflow)</div>
                </div>
                <div class="stage" id="st-paint">
                    <div class="stage-icon">ğŸ¨</div>
                    <div class="stage-name">5. Paint</div>
                    <div class="stage-detail">Pixels (Repaint)</div>
                </div>
                <div class="stage" id="st-comp">
                    <div class="stage-icon">ğŸ“‘</div>
                    <div class="stage-name">6. Composite</div>
                    <div class="stage-detail">GPU Layers</div>
                </div>
            </div>
        </div>

        <div class="visual-area" id="visual">
            <div style="color:#666;">Click "Go" to visualize the Critical Rendering Path</div>
        </div>

        <div class="log-panel">
            <div class="log-title">ğŸ“‹ Rendering Log (å®æ—¶æ—¥å¿—)</div>
            <div id="log-container"></div>
        </div>

        <div class="metrics-panel">
            <div class="metric-card">
                <div class="metric-val" id="m-fp">-</div>
                <div class="metric-label">FP (First Paint)</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="m-fcp">-</div>
                <div class="metric-label">FCP (Content Paint)</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="m-lcp">-</div>
                <div class="metric-label">LCP (Largest Content)</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="m-tti">-</div>
                <div class="metric-label">TTI (Interactive)</div>
            </div>
        </div>

        <div class="opt-panel">
            <div class="opt-title">âš¡ Optimization & Blocking Simulation (è¿è¡Œå‰å‹¾é€‰)</div>
            <div class="opt-group">
                <div class="opt-section optimize">
                    <div class="opt-section-title">âœ… ä¼˜åŒ–é€‰é¡¹ (Optimization)</div>
                    <label class="opt-check"><input type="checkbox" id="opt-dns" onchange="updateOptStatus()"> <span>DNS Prefetch</span></label>
                    <label class="opt-check"><input type="checkbox" id="opt-async" onchange="updateOptStatus()"> <span>Async Scripts</span></label>
                </div>
                <div class="opt-section blocking">
                    <div class="opt-section-title">ğŸ›‘ é˜»å¡æ¨¡æ‹Ÿ (Blocking)</div>
                    <label class="opt-check" id="label-block-js"><input type="checkbox" id="opt-block-js" onchange="updateOptStatus()"> <span>Blocking JS (åŒæ­¥è„šæœ¬)</span></label>
                    <label class="opt-check"><input type="checkbox" id="opt-block-css" onchange="updateOptStatus()"> <span>Blocking CSS (æ ·å¼è¡¨)</span></label>
                </div>
            </div>
            <div class="opt-hint">ğŸ’¡ æç¤º: Async Scripts ä¼šä½¿ Blocking JS å¤±æ•ˆ (asyncè„šæœ¬ä¸é˜»å¡HTMLè§£æ)</div>
            <div class="opt-status" id="opt-status">å½“å‰é…ç½®: é»˜è®¤ (æ— ä¼˜åŒ–, æ— é˜»å¡æ¨¡æ‹Ÿ)</div>
        </div>

        <!-- Browser Process Architecture -->
        <div class="arch-section">
            <div class="arch-title">ğŸ—ï¸ Chrome å¤šè¿›ç¨‹æ¶æ„ (Multi-Process Architecture)</div>
            <div class="arch-diagram">
                <div class="arch-box browser">
                    <div class="arch-box-title">ğŸ–¥ï¸ Browser Process</div>
                    <div class="arch-box-detail">ä¸»è¿›ç¨‹: UI, ä¹¦ç­¾, ç½‘ç»œè¯·æ±‚<br>ç®¡ç†å…¶ä»–è¿›ç¨‹</div>
                </div>
                <div class="arch-box renderer">
                    <div class="arch-box-title">ğŸ“„ Renderer Process</div>
                    <div class="arch-box-detail">æ¯ä¸ªTabä¸€ä¸ªè¿›ç¨‹<br>HTML/CSS/JSè§£ææ¸²æŸ“<br><strong>æœ¬é¡µé¢æ¼”ç¤ºçš„æ ¸å¿ƒ</strong></div>
                </div>
                <div class="arch-box gpu">
                    <div class="arch-box-title">ğŸ® GPU Process</div>
                    <div class="arch-box-detail">å›¾å±‚åˆæˆ<br>3D CSS, Canvas, Video</div>
                </div>
                <div class="arch-box network">
                    <div class="arch-box-title">ğŸŒ Network Process</div>
                    <div class="arch-box-detail">ç½‘ç»œè¯·æ±‚<br>DNS, HTTP, WebSocket</div>
                </div>
            </div>
        </div>

        <!-- defer vs async Comparison -->
        <div class="compare-section">
            <div class="compare-title">ğŸ“ defer vs async vs æ™®é€š script å¯¹æ¯” (é«˜é¢‘é¢è¯•é¢˜)</div>
            <table class="compare-table">
                <tr>
                    <th>ç‰¹æ€§</th>
                    <th>&lt;script&gt;</th>
                    <th>&lt;script async&gt;</th>
                    <th>&lt;script defer&gt;</th>
                </tr>
                <tr>
                    <td><strong>ä¸‹è½½æ—¶æœº</strong></td>
                    <td>ç«‹å³ä¸‹è½½ï¼Œ<span class="tag tag-red">é˜»å¡è§£æ</span></td>
                    <td>å¼‚æ­¥ä¸‹è½½ï¼Œ<span class="tag tag-green">ä¸é˜»å¡</span></td>
                    <td>å¼‚æ­¥ä¸‹è½½ï¼Œ<span class="tag tag-green">ä¸é˜»å¡</span></td>
                </tr>
                <tr>
                    <td><strong>æ‰§è¡Œæ—¶æœº</strong></td>
                    <td>ä¸‹è½½å®Œç«‹å³æ‰§è¡Œ</td>
                    <td>ä¸‹è½½å®Œç«‹å³æ‰§è¡Œ <span class="tag tag-orange">æ— åº</span></td>
                    <td>HTMLè§£æå®Œåæ‰§è¡Œ <span class="tag tag-blue">æœ‰åº</span></td>
                </tr>
                <tr>
                    <td><strong>æ‰§è¡Œé¡ºåº</strong></td>
                    <td>æŒ‰ä¹¦å†™é¡ºåº</td>
                    <td><span class="tag tag-red">è°å…ˆä¸‹è½½å®Œè°å…ˆæ‰§è¡Œ</span></td>
                    <td><span class="tag tag-green">æŒ‰ä¹¦å†™é¡ºåº</span></td>
                </tr>
                <tr>
                    <td><strong>DOMContentLoaded</strong></td>
                    <td>ç­‰å¾…æ‰§è¡Œå®Œ</td>
                    <td>ä¸ç­‰å¾…</td>
                    <td>ç­‰å¾…æ‰§è¡Œå®Œ</td>
                </tr>
                <tr>
                    <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                    <td>å†…è”å…³é”®ä»£ç </td>
                    <td>ç‹¬ç«‹ç»Ÿè®¡/å¹¿å‘Šè„šæœ¬</td>
                    <td><span class="tag tag-green">æ¨è!å¤šæ•°å¸¸è§„JS</span></td>
                </tr>
            </table>
        </div>

        <!-- Performance Tips -->
        <div class="tips-section">
            <div class="compare-title">ğŸš€ æ€§èƒ½ä¼˜åŒ–æŠ€å·§ (Performance Tips)</div>
            <div class="tips-grid">
                <div class="tip-card perf">
                    <div class="tip-title">âœ… æ¨èåšæ³•</div>
                    <div class="tip-content">
                        â€¢ ä½¿ç”¨ <code>transform</code> ä»£æ›¿ top/left åŠ¨ç”»<br>
                        â€¢ ä½¿ç”¨ <code>opacity</code> ä»£æ›¿ visibility<br>
                        â€¢ ä½¿ç”¨ <code>will-change</code> æç¤ºæµè§ˆå™¨<br>
                        â€¢ CSSæ”¾<code>&lt;head&gt;</code>ï¼ŒJSæ”¾<code>&lt;/body&gt;</code>å‰
                    </div>
                    <div class="tip-code">// åªè§¦å‘ Compositeï¼Œè·³è¿‡ Layout/Paint<br>transform: translateX(100px);</div>
                </div>
                <div class="tip-card avoid">
                    <div class="tip-title">âŒ é¿å…åšæ³•</div>
                    <div class="tip-content">
                        â€¢ é¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€ (offsetWidth)<br>
                        â€¢ é¿å…é¢‘ç¹ DOM æ“ä½œ<br>
                        â€¢ é¿å…å¤§é‡ä½¿ç”¨ table å¸ƒå±€<br>
                        â€¢ é¿å… CSS è¡¨è¾¾å¼ (calc é™¤å¤–)
                    </div>
                    <div class="tip-code">// å¼ºåˆ¶åŒæ­¥å¸ƒå±€ - é¿å…!<br>el.style.width = '100px';<br>console.log(el.offsetWidth); // å¼ºåˆ¶é‡æ’</div>
                </div>
                <div class="tip-card">
                    <div class="tip-title">ğŸ¯ Core Web Vitals</div>
                    <div class="tip-content">
                        <strong>LCP</strong> &lt; 2.5s (æœ€å¤§å†…å®¹ç»˜åˆ¶)<br>
                        <strong>FID</strong> &lt; 100ms (é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ)<br>
                        <strong>CLS</strong> &lt; 0.1 (ç´¯ç§¯å¸ƒå±€åç§»)<br>
                        <em>è¿™æ˜¯Googleæœç´¢æ’åå› ç´ !</em>
                    </div>
                </div>
                <div class="tip-card perf">
                    <div class="tip-title">ğŸ“¦ èµ„æºåŠ è½½ä¼˜åŒ–</div>
                    <div class="tip-content">
                        â€¢ <code>&lt;link rel="preload"&gt;</code> é¢„åŠ è½½å…³é”®èµ„æº<br>
                        â€¢ <code>&lt;link rel="prefetch"&gt;</code> é¢„å–ä¸‹ä¸€é¡µ<br>
                        â€¢ <code>&lt;link rel="preconnect"&gt;</code> é¢„è¿æ¥<br>
                        â€¢ å›¾ç‰‡æ‡’åŠ è½½ <code>loading="lazy"</code>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interview Q&A -->
        <div class="compare-section">
            <div class="compare-title">ğŸ¯ é«˜é¢‘é¢è¯•é¢˜ (Interview Questions)</div>
        </div>
        <div class="interview-panel">
            <div class="qa-card">
                <div class="qa-q">Q: ä»€ä¹ˆæ˜¯é‡æ’(Reflow)å’Œé‡ç»˜(Repaint)ï¼Ÿ</div>
                <div class="qa-a">
                    <strong>é‡æ’ (Reflow/Layout):</strong> å‡ ä½•å±æ€§å˜åŒ–(width/height/position)ã€‚<span class="tag tag-red">ä»£ä»·é«˜</span> å½±å“æ‰€æœ‰å­/çˆ¶èŠ‚ç‚¹<br>
                    <strong>é‡ç»˜ (Repaint):</strong> å¤–è§‚å˜åŒ–(color/background)ä½†å‡ ä½•ä¸å˜ã€‚<span class="tag tag-orange">ä»£ä»·è¾ƒä½</span><br>
                    <strong>æœ€ä¼˜:</strong> ç”¨ <code>transform/opacity</code> åŠ¨ç”»ï¼Œåªè§¦å‘ Composite <span class="tag tag-green">ä»£ä»·æœ€ä½</span>
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: ä¸ºä»€ä¹ˆè¦æŠŠJSæ”¾åœ¨bodyåº•éƒ¨ï¼Ÿ</div>
                <div class="qa-a">
                    JSä¼šé˜»å¡HTMLè§£æ (Parser Blocking)ã€‚å¦‚æœåœ¨ <code>&lt;head&gt;</code> ä¸­ï¼Œæµè§ˆå™¨ä¼šæš‚åœDOMæ„å»ºå»ä¸‹è½½æ‰§è¡ŒJSã€‚<br>
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong> ä½¿ç”¨ <code>defer</code>(æŒ‰åºæ‰§è¡Œ) æˆ– <code>async</code>(æ— åºæ‰§è¡Œ)
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: ä»€ä¹ˆæ˜¯å…³é”®æ¸²æŸ“è·¯å¾„(CRP)ï¼Ÿ</div>
                <div class="qa-a">
                    æµè§ˆå™¨å°† HTML/CSS/JS è½¬æ¢ä¸ºå±å¹•åƒç´ çš„æ­¥éª¤åºåˆ—ã€‚<br>
                    <strong>ä¼˜åŒ–ç›®æ ‡:</strong> å‡å°‘å…³é”®èµ„æºæ•°é‡å’Œå­—èŠ‚æ•°ï¼ŒåŠ é€Ÿ First Paint
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: CSSå¦‚ä½•å½±å“æ¸²æŸ“ï¼Ÿ</div>
                <div class="qa-a">
                    CSS æ˜¯<strong>æ¸²æŸ“é˜»å¡</strong>çš„ã€‚CSSOMæ„å»ºå®Œæˆå‰ä¸ä¼šæ¸²æŸ“ä»»ä½•å†…å®¹(é¿å…FOUC-æ— æ ·å¼é—ªçƒ)ã€‚<br>
                    <strong>Tip:</strong> å†…è”å…³é”®CSSï¼Œå¼‚æ­¥åŠ è½½éå…³é”®CSS
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: è§£é‡Šä¸€ä¸‹æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯(Event Loop)ï¼Ÿ</div>
                <div class="qa-a">
                    <strong>å®ä»»åŠ¡:</strong> script, setTimeout, setInterval, I/O<br>
                    <strong>å¾®ä»»åŠ¡:</strong> Promise.then, MutationObserver, queueMicrotask<br>
                    <strong>æ‰§è¡Œé¡ºåº:</strong> å®ä»»åŠ¡ â†’ æ‰€æœ‰å¾®ä»»åŠ¡ â†’ æ¸²æŸ“ â†’ ä¸‹ä¸€ä¸ªå®ä»»åŠ¡<br>
                    <em>requestAnimationFrame åœ¨æ¸²æŸ“å‰æ‰§è¡Œ!</em>
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: ä»€ä¹ˆå¯¼è‡´ç™½å±ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</div>
                <div class="qa-a">
                    <strong>åŸå› :</strong> åŒæ­¥JSåœ¨ <code>&lt;head&gt;</code> ä¸­é˜»å¡è§£æï¼›CSSæ–‡ä»¶è¿‡å¤§ã€‚<br>
                    <strong>ä¼˜åŒ–:</strong> JSåŠ defer/asyncï¼ŒCSSæ‹†åˆ†+å†…è”å…³é”®æ ·å¼ï¼Œéª¨æ¶å±ã€‚
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: å¦‚ä½•å‡å°‘é‡æ’ï¼Ÿ</div>
                <div class="qa-a">
                    â€¢ æ‰¹é‡DOMæ“ä½œç”¨ DocumentFragment<br>
                    â€¢ è¯»å†™åˆ†ç¦»ï¼Œé¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€<br>
                    â€¢ ä½¿ç”¨ <code>transform</code> ä»£æ›¿ top/left<br>
                    â€¢ å°†åŠ¨ç”»å…ƒç´ è„±ç¦»æ–‡æ¡£æµ (absolute/fixed)
                </div>
            </div>
            <div class="qa-card">
                <div class="qa-q">Q: preload vs prefetch vs preconnect?</div>
                <div class="qa-a">
                    <strong>preload:</strong> å½“å‰é¡µå¿…éœ€èµ„æºï¼Œé«˜ä¼˜å…ˆçº§é¢„åŠ è½½<br>
                    <strong>prefetch:</strong> ä¸‹ä¸€é¡µå¯èƒ½éœ€è¦ï¼Œç©ºé—²æ—¶é¢„å–<br>
                    <strong>preconnect:</strong> æå‰å»ºç«‹TCP+TLSè¿æ¥<br>
                    <strong>dns-prefetch:</strong> åªåšDNSè§£æ
                </div>
            </div>
        </div>
    </div>

    <script>
        const visual = document.getElementById('visual');
        const logContainer = document.getElementById('log-container');
        let startTime = 0;
        
        // Ensure global access
        window.reset = reset;
        window.startProcess = startProcess;
        window.updateOptStatus = updateOptStatus;

        // Update option status display
        function updateOptStatus() {
            const dns = document.getElementById('opt-dns').checked;
            const async = document.getElementById('opt-async').checked;
            const blockJs = document.getElementById('opt-block-js').checked;
            const blockCss = document.getElementById('opt-block-css').checked;
            
            // Visual feedback: Async makes Blocking JS ineffective
            const blockJsLabel = document.getElementById('label-block-js');
            if (async) {
                blockJsLabel.classList.add('disabled');
                blockJsLabel.title = 'Async Scripts å·²å¯ç”¨ï¼ŒJSä¸ä¼šé˜»å¡';
            } else {
                blockJsLabel.classList.remove('disabled');
                blockJsLabel.title = '';
            }
            
            // Build status text
            let optimizations = [];
            let blockings = [];
            
            if (dns) optimizations.push('DNS Prefetch');
            if (async) optimizations.push('Async Scripts');
            if (blockJs && !async) blockings.push('Blocking JS (+2s)');
            if (blockJs && async) blockings.push('<s>Blocking JS</s> (è¢«Asyncè¦†ç›–)');
            if (blockCss) blockings.push('Blocking CSS (+2s)');
            
            let status = 'å½“å‰é…ç½®: ';
            if (optimizations.length > 0) {
                status += 'âœ… ' + optimizations.join(', ');
            }
            if (blockings.length > 0) {
                status += (optimizations.length > 0 ? ' | ' : '') + 'ğŸ›‘ ' + blockings.join(', ');
            }
            if (optimizations.length === 0 && blockings.length === 0) {
                status += 'é»˜è®¤ (æ— ä¼˜åŒ–, æ— é˜»å¡æ¨¡æ‹Ÿ)';
            }
            
            document.getElementById('opt-status').innerHTML = status;
        }

        function log(stage, message, type) {
            const elapsed = Date.now() - startTime;
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.innerHTML = `<span class="log-time">${elapsed}ms</span><span class="log-stage">[${stage}]</span><span class="log-msg">${message}</span>`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function reset() {
            visual.innerHTML = '<div style="color:#666;">Click "Go" to visualize the Critical Rendering Path</div>';
            logContainer.innerHTML = '';
            document.querySelectorAll('.stage').forEach(s => s.classList.remove('active'));
            document.getElementById('btnStart').disabled = false;
            ['m-fp', 'm-fcp', 'm-lcp', 'm-tti'].forEach(id => document.getElementById(id).innerText = '-');
            document.getElementById('progress-bar').style.width = '0%';
        }

        async function startProcess() {
            console.log("Starting process...");
            document.getElementById('btnStart').disabled = true;
            visual.innerHTML = '';
            logContainer.innerHTML = '';
            startTime = Date.now();
            
            // Read options
            const optDns = document.getElementById('opt-dns').checked;
            const optAsync = document.getElementById('opt-async').checked;
            const optBlockJs = document.getElementById('opt-block-js').checked;
            const optBlockCss = document.getElementById('opt-block-css').checked;
            
            log('START', 'ğŸš€ å¼€å§‹æ¸²æŸ“æµç¨‹...', 'network');
            
            // Log current config
            if (optDns || optAsync || optBlockJs || optBlockCss) {
                let configMsg = 'ğŸ“‹ é…ç½®: ';
                if (optDns) configMsg += '[DNS Prefetch] ';
                if (optAsync) configMsg += '[Async Scripts] ';
                if (optBlockJs) configMsg += '[Blocking JS] ';
                if (optBlockCss) configMsg += '[Blocking CSS] ';
                log('CONFIG', configMsg, 'network');
            }
            
            // 1. Network
            await runStage('st-dns', async () => {
                if (optDns) {
                    log('Network', 'âš¡ DNS Prefetch å‘½ä¸­! è·³è¿‡DNSæŸ¥è¯¢ (å·²é¢„è§£æ)', 'network');
                    visual.innerHTML = '<div style="text-align:center;color:#4caf50;">âœ… DNS Prefetch Hit!<br>Skip DNS lookup</div>';
                    await wait(100);
                } else {
                    log('Network', 'ğŸ“¡ DNSæŸ¥è¯¢: www.example.com -> 93.184.216.34', 'network');
                    visual.innerHTML = '<div style="text-align:center;">DNS Lookup...<br>TCP Handshake (SYN, SYN-ACK, ACK)...<br>HTTP GET /index.html</div>';
                    await wait(400);
                }
                log('Network', 'ğŸ¤ TCPä¸‰æ¬¡æ¡æ‰‹: SYN -> SYN-ACK -> ACK', 'network');
                await wait(optDns ? 200 : 400);
                log('Network', 'ğŸ“¥ HTTP GET /index.html (200 OK, 2.3KB)', 'network');
                visual.innerHTML = '<div style="text-align:center;">Receiving Bytes...<br>1010101010...</div>';
            }, 16);


            // 2. Parsing
            await runStage('st-parse', async () => {
                log('Parse', 'ğŸ“„ å¼€å§‹è§£æHTMLæ–‡æ¡£...', 'parse');
                visual.innerHTML = '';
                const domContainer = document.createElement('div');
                domContainer.style.display = 'flex';
                domContainer.style.flexDirection = 'column';
                domContainer.style.alignItems = 'center';
                
                // DOM
                const domTitle = document.createElement('div');
                domTitle.innerText = "DOM Tree";
                domTitle.style.color = "#ff9800";
                domContainer.appendChild(domTitle);
                
                const html = createNode('html', 'dom');
                const body = createNode('body', 'dom');
                const div = createNode('div', 'dom');
                
                log('Parse', 'ğŸŒ³ æ„å»ºDOM: <html> èŠ‚ç‚¹', 'parse');
                domContainer.appendChild(html);
                await wait(200);
                
                // Simulate Blocking JS
                if (optBlockJs) {
                    if (optAsync) {
                        // Async script - doesn't block
                        log('Parse', 'ğŸ“œ é‡åˆ° &lt;script async&gt;ï¼Œä¸é˜»å¡è§£æ!', 'parse');
                        const script = createNode('<scr' + 'ipt async>...', 'dom');
                        script.style.borderColor = '#4caf50';
                        script.style.background = '#1b5e20';
                        domContainer.appendChild(script);
                        visual.appendChild(domContainer);
                        
                        const asyncMsg = document.createElement('div');
                        asyncMsg.innerText = "âœ… Async Script: å¹¶è¡Œä¸‹è½½ï¼Œä¸é˜»å¡è§£æ";
                        asyncMsg.style.color = "#4caf50";
                        asyncMsg.style.marginTop = "10px";
                        asyncMsg.style.fontSize = "1rem";
                        asyncMsg.style.fontWeight = "bold";
                        visual.appendChild(asyncMsg);
                        
                        await wait(500);
                        asyncMsg.remove();
                        log('Parse', 'âœ… Asyncè„šæœ¬åå°ä¸‹è½½ä¸­ï¼ŒHTMLè§£æç»§ç»­...', 'parse');
                    } else {
                        // Sync script - blocks parsing
                        log('Parse', 'âš ï¸ é‡åˆ°åŒæ­¥ &lt;script&gt;ï¼Œæš‚åœHTMLè§£æ!', 'parse');
                        const script = createNode('<scr' + 'ipt>...', 'dom');
                        script.style.borderColor = 'red';
                        domContainer.appendChild(script);
                        visual.appendChild(domContainer);
                        
                        const blockMsg = document.createElement('div');
                        blockMsg.innerText = "âš ï¸ Parser Blocked by Sync JS...";
                        blockMsg.style.color = "red";
                        blockMsg.style.marginTop = "10px";
                        blockMsg.style.fontSize = "1.2rem";
                        blockMsg.style.fontWeight = "bold";
                        visual.appendChild(blockMsg);
                        
                        log('Parse', 'â³ ä¸‹è½½å¹¶æ‰§è¡ŒJSä¸­... (+2000ms)', 'parse');
                        await wait(2000); // Blocking delay
                        blockMsg.remove();
                        log('Parse', 'âœ… JSæ‰§è¡Œå®Œæ¯•ï¼Œç»§ç»­è§£æ', 'parse');
                    }
                }

                log('Parse', 'ğŸŒ³ æ„å»ºDOM: <body> èŠ‚ç‚¹', 'parse');
                domContainer.appendChild(body);
                await wait(200);
                log('Parse', 'ğŸŒ³ æ„å»ºDOM: <div> èŠ‚ç‚¹', 'parse');
                domContainer.appendChild(div);
                
                visual.innerHTML = ''; // Clear for clean redraw
                visual.appendChild(domContainer);

                // CSSOM
                const cssContainer = document.createElement('div');
                cssContainer.style.display = 'flex';
                cssContainer.style.flexDirection = 'column';
                cssContainer.style.alignItems = 'center';
                cssContainer.style.marginLeft = "50px";

                const cssTitle = document.createElement('div');
                cssTitle.innerText = "CSSOM Tree";
                cssTitle.style.color = "#2196f3";
                cssContainer.appendChild(cssTitle);

                // Simulate Blocking CSS
                if (optBlockCss) {
                    log('Parse', 'âš ï¸ ç­‰å¾…CSSä¸‹è½½ (Render Blocking)...', 'parse');
                    log('Parse', 'â³ CSSæ˜¯æ¸²æŸ“é˜»å¡èµ„æº... (+2000ms)', 'parse');
                    const blockMsg = document.createElement('div');
                    blockMsg.innerText = "âš ï¸ Render Blocked by CSS...";
                    blockMsg.style.color = "red";
                    blockMsg.style.marginTop = "10px";
                    blockMsg.style.fontSize = "1.2rem";
                    blockMsg.style.fontWeight = "bold";
                    visual.appendChild(blockMsg);
                    await wait(2000);
                    blockMsg.remove();
                    log('Parse', 'âœ… CSSä¸‹è½½å®Œæ¯•', 'parse');
                }

                log('Parse', 'ğŸ¨ æ„å»ºCSSOM: body { margin: 0 }', 'parse');
                const rule1 = createNode('body { m:0 }', 'cssom');
                const rule2 = createNode('div { color:red }', 'cssom');

                cssContainer.appendChild(rule1);
                await wait(200);
                log('Parse', 'ğŸ¨ æ„å»ºCSSOM: div { color: red }', 'parse');
                cssContainer.appendChild(rule2);
                
                visual.appendChild(cssContainer);
                log('Parse', 'âœ… DOM + CSSOM æ„å»ºå®Œæˆ', 'parse');
            }, 32);

            // 3. Render Tree
            await runStage('st-render', async () => {
                log('Render', 'ğŸŒ³ å¼€å§‹æ„å»ºæ¸²æŸ“æ ‘ (DOM + CSSOM)', 'render');
                visual.innerHTML = '<div style="margin-bottom:10px; width:100%; text-align:center;">Combining DOM + CSSOM... Excluding "display:none"</div>';
                const tree = document.createElement('div');
                tree.style.display = 'flex';
                tree.style.flexDirection = 'column';
                tree.style.alignItems = 'center';
                
                const rBody = createNode('RenderBody', 'render');
                const rDiv = createNode('RenderDiv (red)', 'render');
                
                log('Render', 'â• æ·»åŠ å¯è§èŠ‚ç‚¹: RenderBody', 'render');
                tree.appendChild(rBody);
                await wait(300);
                log('Render', 'â• æ·»åŠ å¯è§èŠ‚ç‚¹: RenderDiv (å«æ ·å¼)', 'render');
                tree.appendChild(rDiv);
                log('Render', 'âŒ è·³è¿‡ display:none çš„èŠ‚ç‚¹', 'render');
                
                visual.appendChild(tree);
                log('Render', 'âœ… æ¸²æŸ“æ ‘æ„å»ºå®Œæˆ (2ä¸ªå¯è§èŠ‚ç‚¹)', 'render');
            }, 48);

            // 4. Layout
            await runStage('st-layout', async () => {
                log('Layout', 'ğŸ“ å¼€å§‹å¸ƒå±€è®¡ç®— (Reflow)', 'layout');
                visual.innerHTML = '<div style="position:absolute; top:10px; left:10px;">Calculating Geometry... (x, y, width, height)</div>';
                
                const box = document.createElement('div');
                box.style.border = '2px dashed #fff';
                box.style.width = '100px';
                box.style.height = '100px';
                box.style.position = 'absolute';
                box.style.top = '50%';
                box.style.left = '50%';
                box.style.transform = 'translate(-50%, -50%)';
                box.innerText = 'Box';
                box.style.display = 'flex';
                box.style.alignItems = 'center';
                box.style.justifyContent = 'center';
                
                log('Layout', 'ğŸ“ è®¡ç®— body: x=0, y=0, w=100%, h=auto', 'layout');
                await wait(200);
                log('Layout', 'ğŸ“ è®¡ç®— div: x=center, y=center, w=100px, h=100px', 'layout');
                
                visual.appendChild(box);
                log('Layout', 'âœ… å¸ƒå±€è®¡ç®—å®Œæˆ', 'layout');
            }, 64);

            // 5. Paint
            await runStage('st-paint', async () => {
                log('Paint', 'ğŸ¨ å¼€å§‹ç»˜åˆ¶ (Repaint)', 'paint');
                const box = visual.lastElementChild; // The box from layout
                
                log('Paint', 'ğŸ–Œï¸ ç»˜åˆ¶èƒŒæ™¯è‰²: #f44336 (red)', 'paint');
                box.style.border = 'none';
                box.style.background = '#f44336'; // Red
                box.style.boxShadow = '0 0 20px rgba(244, 67, 54, 0.5)';
                box.innerText = 'Painted';
                
                log('Paint', 'ğŸ–Œï¸ ç»˜åˆ¶æ–‡å­—: "Painted"', 'paint');
                log('Paint', 'ğŸ–Œï¸ ç»˜åˆ¶é˜´å½±æ•ˆæœ', 'paint');
                
                // Metrics Update
                const elapsed = Date.now() - startTime;
                document.getElementById('m-fp').innerText = (elapsed * 0.6).toFixed(0) + 'ms';
                document.getElementById('m-fcp').innerText = (elapsed * 0.7).toFixed(0) + 'ms';
                log('Paint', 'ğŸ“Š FP: ' + (elapsed * 0.6).toFixed(0) + 'ms, FCP: ' + (elapsed * 0.7).toFixed(0) + 'ms', 'paint');
            }, 80);

            // 6. Composite
            await runStage('st-comp', async () => {
                log('Composite', 'ğŸ“‘ å¼€å§‹åˆæˆå›¾å±‚ (GPUåŠ é€Ÿ)', 'composite');
                const box = visual.lastElementChild;
                
                log('Composite', 'ğŸ”² åˆ›å»ºç‹¬ç«‹å›¾å±‚: div (will-change: transform)', 'composite');
                box.style.transform = 'translate(-50%, -50%) scale(1.2)';
                box.style.transition = 'transform 0.5s';
                
                log('Composite', 'ğŸ”€ åˆå¹¶å›¾å±‚åˆ°å¸§ç¼“å†²åŒº', 'composite');
                visual.innerHTML += '<div style="position:absolute; bottom:10px; width:100%; text-align:center;">Layers Merged to Screen</div>';
                
                const elapsed = Date.now() - startTime;
                document.getElementById('m-lcp').innerText = elapsed.toFixed(0) + 'ms';
                document.getElementById('m-tti').innerText = (elapsed + 200).toFixed(0) + 'ms';
                
                log('Composite', 'ğŸ“Š LCP: ' + elapsed.toFixed(0) + 'ms, TTI: ' + (elapsed + 200).toFixed(0) + 'ms', 'composite');
                log('Composite', 'ğŸ–¥ï¸ è¾“å‡ºåˆ°å±å¹•!', 'composite');
            }, 100);
            
            log('DONE', 'ğŸ‰ æ¸²æŸ“å®Œæˆ!', 'network');
            document.getElementById('btnStart').disabled = false;
        }

        function createNode(text, type) {
            const div = document.createElement('div');
            div.className = 'tree-node ' + type;
            div.innerText = text;
            return div;
        }

        async function runStage(id, action, progressPercent) {
            document.querySelectorAll('.stage').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('progress-bar').style.width = progressPercent + '%';
            await action();
            await wait(1000);
        }

        function wait(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
    </script>
</body>
</html>
