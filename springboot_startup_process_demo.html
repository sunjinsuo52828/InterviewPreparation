<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot Startup Process Visualization</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        h1 { color: #6db33f; } /* Spring Green */
        
        .container { display: flex; width: 100%; max-width: 1000px; gap: 20px; }
        
        .timeline { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            position: relative; padding: 20px 0;
        }
        .timeline::before {
            content: ''; position: absolute; top: 0; bottom: 0; left: 50%; width: 4px; background: #ddd; transform: translateX(-50%); z-index: 0;
        }
        
        .step {
            background: white; border: 2px solid #6db33f; border-radius: 8px; padding: 15px; width: 300px;
            margin-bottom: 20px; z-index: 1; text-align: center; cursor: pointer; transition: all 0.3s;
            position: relative;
        }
        .step.active { background: #6db33f; color: white; transform: scale(1.05); box-shadow: 0 4px 15px rgba(109, 179, 63, 0.4); }
        .step.completed { background: #e8f5e9; border-color: #2e7d32; color: #2e7d32; }
        
        .details-panel {
            flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            height: fit-content; position: sticky; top: 20px;
        }
        .details-panel h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .details-content { font-size: 1rem; line-height: 1.6; color: #555; }
        .code-snippet { background: #2d2d2d; color: #ccc; padding: 10px; border-radius: 4px; font-family: monospace; margin-top: 10px; overflow-x: auto; }
        
        .controls { margin-bottom: 20px; position: sticky; top: 0; z-index: 100; background: #f0f2f5; padding: 10px; width: 100%; text-align: center; }
        button { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #555; }

    </style>
</head>
<body>
    <h1>Spring Boot Startup Process</h1>
    
    <div class="controls">
        <button onclick="prevStep()">Previous</button>
        <button onclick="nextStep()" id="btn-next">Start / Next</button>
        <button onclick="reset()">Reset</button>
    </div>

    <div class="container">
        <div class="timeline" id="timeline">
            <!-- Steps generated by JS -->
        </div>
        <div class="details-panel">
            <h2 id="detail-title">Welcome</h2>
            <div id="detail-content" class="details-content">
                Click "Start" to walk through the `SpringApplication.run()` method execution flow.
            </div>
        </div>
    </div>

    <script>
        const steps = [
            {
                id: 'start',
                title: 'SpringApplication.run()',
                desc: 'The entry point of the application. Static helper that creates an instance of SpringApplication and calls run().',
                code: 'public static ConfigurableApplicationContext run(Class<?>[] primarySources, String[] args) {\n    return new SpringApplication(primarySources).run(args);\n}'
            },
            {
                id: 'bootstrap',
                title: '1. Create Bootstrap Context',
                desc: 'Initializes the bootstrap context (if cloud features are present) and starts the StopWatch to measure startup time.',
                code: 'StopWatch stopWatch = new StopWatch();\nstopWatch.start();\nDefaultBootstrapContext bootstrapContext = createBootstrapContext();'
            },
            {
                id: 'listeners',
                title: '2. Get Run Listeners',
                desc: 'Loads `SpringApplicationRunListener`s from `spring.factories`. These listeners hook into various stages of the lifecycle.',
                code: 'SpringApplicationRunListeners listeners = getRunListeners(args);\nlisteners.starting(bootstrapContext, this.mainApplicationClass);'
            },
            {
                id: 'environment',
                title: '3. Prepare Environment',
                desc: 'Creates and configures the `ConfigurableEnvironment`. Loads properties (application.properties, system props, etc.) and binds them.',
                code: 'ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments);'
            },
            {
                id: 'create-context',
                title: '4. Create ApplicationContext',
                desc: 'Instantiates the appropriate ApplicationContext strategy (e.g., `AnnotationConfigServletWebServerApplicationContext` for web apps).',
                code: 'context = createApplicationContext();'
            },
            {
                id: 'prepare-context',
                title: '5. Prepare Context',
                desc: 'Applies initializers, loads bean definitions from sources, and notifies listeners that context is prepared but not refreshed.',
                code: 'prepareContext(context, environment, listeners, applicationArguments, printedBanner);'
            },
            {
                id: 'refresh',
                title: '6. Refresh Context (The Core)',
                desc: 'The heart of Spring. <code>AbstractApplicationContext.refresh()</code> performs these 12 steps:<br>' +
                      '<ol style="text-align:left; font-size:0.9rem; margin-top:5px;">' +
                      '<li><b>prepareRefresh()</b>: Set start time, active flag, init property sources.</li>' +
                      '<li><b>obtainFreshBeanFactory()</b>: Load BeanDefinitions (XML/JavaConfig), create BeanFactory.</li>' +
                      '<li><b>prepareBeanFactory()</b>: Configure ClassLoader, BPPs, ignore interfaces.</li>' +
                      '<li><b>postProcessBeanFactory()</b>: Hook for subclasses (e.g., WebContext registers ServletContextAware).</li>' +
                      '<li><b>invokeBeanFactoryPostProcessors()</b>: Run BFPPs (e.g., scan packages, replace placeholders).</li>' +
                      '<li><b>registerBeanPostProcessors()</b>: Find and register BPPs (AutowiredAnnotationBPP, etc.).</li>' +
                      '<li><b>initMessageSource()</b>: Setup i18n.</li>' +
                      '<li><b>initApplicationEventMulticaster()</b>: Setup event broadcasting.</li>' +
                      '<li><b>onRefresh()</b>: Special bean init (e.g., <b>Create Embedded Web Server</b> like Tomcat).</li>' +
                      '<li><b>registerListeners()</b>: Register ApplicationListeners.</li>' +
                      '<li><b>finishBeanFactoryInitialization()</b>: <b>Instantiate all non-lazy singletons</b>. (DI, AOP proxies created here).</li>' +
                      '<li><b>finishRefresh()</b>: Publish ContextRefreshedEvent, start LifecycleProcessor.</li>' +
                      '</ol>',
                code: 'public void refresh() throws BeansException, IllegalStateException {\n    synchronized (this.startupShutdownMonitor) {\n        prepareRefresh();\n        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();\n        prepareBeanFactory(beanFactory);\n        try {\n            postProcessBeanFactory(beanFactory);\n            invokeBeanFactoryPostProcessors(beanFactory);\n            registerBeanPostProcessors(beanFactory);\n            initMessageSource();\n            initApplicationEventMulticaster();\n            onRefresh();\n            registerListeners();\n            finishBeanFactoryInitialization(beanFactory);\n            finishRefresh();\n        } ...\n    }\n}'
            },
            {
                id: 'runners',
                title: '7. Call Runners',
                desc: 'Executes `CommandLineRunner` and `ApplicationRunner` beans after the context is fully started.',
                code: 'callRunners(context, applicationArguments);'
            },
            {
                id: 'finish',
                title: '8. Ready',
                desc: 'Startup complete. The application is now running and ready to accept requests.',
                code: 'listeners.running(context);\nreturn context;'
            }
        ];

        let currentStepIndex = -1;

        function init() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            steps.forEach((step, index) => {
                const div = document.createElement('div');
                div.className = 'step';
                div.id = 'step-' + index;
                div.innerText = step.title;
                div.onclick = () => jumpTo(index);
                timeline.appendChild(div);
            });
        }

        function nextStep() {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                updateUI();
            }
        }

        function prevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                updateUI();
            }
        }
        
        function jumpTo(index) {
            currentStepIndex = index;
            updateUI();
        }

        function reset() {
            currentStepIndex = -1;
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active', 'completed');
            });
            document.getElementById('detail-title').innerText = 'Welcome';
            document.getElementById('detail-content').innerHTML = 'Click "Start" to walk through the `SpringApplication.run()` method execution flow.';
        }

        function updateUI() {
            // Update Steps
            steps.forEach((step, index) => {
                const el = document.getElementById('step-' + index);
                el.classList.remove('active', 'completed');
                if (index < currentStepIndex) el.classList.add('completed');
                if (index === currentStepIndex) el.classList.add('active');
            });

            // Update Details
            const step = steps[currentStepIndex];
            document.getElementById('detail-title').innerText = step.title;
            document.getElementById('detail-content').innerHTML = `
                <p>${step.desc}</p>
                <div class="code-snippet"><pre>${step.code}</pre></div>
            `;
            
            // Scroll into view
            document.getElementById('step-' + currentStepIndex).scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        init();

    </script>
</body>
</html>