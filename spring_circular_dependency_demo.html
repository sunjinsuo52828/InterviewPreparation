<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Circular Dependency Resolution</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        h1 { color: #6db33f; }
        
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; margin-top: 20px; }
        
        .flow-panel { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .cache-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        
        .cache-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #0078d4; min-height: 100px; }
        .cache-title { font-weight: bold; margin-bottom: 10px; color: #333; display: flex; justify-content: space-between; }
        .cache-desc { font-size: 0.8rem; color: #666; margin-bottom: 10px; }
        .cache-content { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .bean { 
            width: 80px; height: 80px; border-radius: 50%; background: #e1f5fe; border: 2px solid #0288d1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; transition: all 0.5s; position: relative;
        }
        .bean.incomplete { border-style: dashed; background: #fff3e0; border-color: #ef6c00; }
        .bean-prop { font-size: 0.7rem; margin-top: 5px; }
        
        .controls { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        button { background: #0078d4; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:disabled { background: #ccc; }

        .log-box { 
            background: #333; color: #0f0; font-family: monospace; padding: 10px; 
            height: 200px; overflow-y: auto; border-radius: 5px; margin-top: 20px; width: 100%; box-sizing: border-box;
        }
        
        .highlight { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 120, 212, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 120, 212, 0); } }

    </style>
</head>
<body>
    <h1>Spring Circular Dependency (Three-Level Cache)</h1>
    
    <div class="controls">
        <button onclick="nextStep()" id="btn-next">Next Step</button>
        <button onclick="reset()">Reset</button>
        <div style="margin-top: 10px; font-size: 0.9rem;">
            Scenario: Bean A depends on Bean B, and Bean B depends on Bean A.
        </div>
    </div>

    <div class="container">
        <div class="flow-panel">
            <h3>Creation Flow</h3>
            <div id="flow-diagram" style="position: relative; height: 300px; border: 1px solid #eee;">
                <!-- Visualization of A and B creation status -->
                <div id="placeholder-a" style="position: absolute; top: 50px; left: 50px; width: 100px; height: 100px; border: 2px dashed #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc;">A</div>
                <div id="placeholder-b" style="position: absolute; top: 50px; right: 50px; width: 100px; height: 100px; border: 2px dashed #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc;">B</div>
                
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#333" />
                        </marker>
                    </defs>
                    <line id="dep-a-b" x1="160" y1="100" x2="340" y2="100" stroke="#ccc" stroke-width="2" marker-end="url(#arrow)" style="opacity: 0;" />
                    <text id="text-a-b" x="250" y="90" text-anchor="middle" fill="#666" style="opacity: 0; font-size: 0.8rem;">needs B</text>
                    
                    <line id="dep-b-a" x1="340" y1="120" x2="160" y2="120" stroke="#ccc" stroke-width="2" marker-end="url(#arrow)" style="opacity: 0;" />
                    <text id="text-b-a" x="250" y="140" text-anchor="middle" fill="#666" style="opacity: 0; font-size: 0.8rem;">needs A</text>
                </svg>
            </div>
            <div class="log-box" id="log"></div>
        </div>

        <div class="cache-panel">
            <div class="cache-box" id="cache-1">
                <div class="cache-title">1. singletonObjects (Level 1) <span>Ready Beans</span></div>
                <div class="cache-desc">Fully initialized beans.</div>
                <div class="cache-content" id="content-1"></div>
            </div>
            <div class="cache-box" id="cache-2">
                <div class="cache-title">2. earlySingletonObjects (Level 2) <span>Semi-Ready</span></div>
                <div class="cache-desc">Instantiated but not populated beans (promoted from factories).</div>
                <div class="cache-content" id="content-2"></div>
            </div>
            <div class="cache-box" id="cache-3">
                <div class="cache-title">3. singletonFactories (Level 3) <span>Factories</span></div>
                <div class="cache-desc">Object Factories to create early references (supports AOP).</div>
                <div class="cache-content" id="content-3"></div>
            </div>
        </div>
    </div>

    <script>
        let step = 0;
        const logEl = document.getElementById('log');

        function log(msg) {
            logEl.innerHTML += `> ${msg}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function createBeanElement(name, state) {
            const div = document.createElement('div');
            div.className = `bean ${state === 'incomplete' ? 'incomplete' : ''}`;
            div.id = `bean-${name}`;
            div.innerHTML = `${name}<div class="bean-prop">${state}</div>`;
            return div;
        }

        function updateBeanState(name, state) {
            const el = document.getElementById(`bean-${name}`);
            if (el) {
                el.className = `bean ${state === 'incomplete' ? 'incomplete' : ''}`;
                el.innerHTML = `${name}<div class="bean-prop">${state}</div>`;
            }
        }

        function moveBean(name, targetCacheId) {
            const el = document.getElementById(`bean-${name}`);
            if (el) el.remove();
            
            // If moving to factory, it's represented differently usually, but for visual simplicity we keep the bean circle
            // In Level 3, it's a Factory (lambda), but we visualize it as the bean "potential".
            
            const target = document.getElementById(`content-${targetCacheId}`);
            const newEl = createBeanElement(name, targetCacheId === 3 ? 'Factory' : (targetCacheId === 2 ? 'Incomplete' : 'Ready'));
            target.appendChild(newEl);
        }

        const steps = [
            {
                desc: "Application Context starts. User requests `getBean('A')`.",
                action: () => {
                    log("Client calls getBean('A').");
                    log("Checking Level 1 Cache... Not found.");
                    log("Checking Level 2 Cache... Not found.");
                    log("Checking Level 3 Cache... Not found.");
                    log("Creating Bean 'A'...");
                }
            },
            {
                desc: "Bean A is instantiated (Constructor called).",
                action: () => {
                    log("Bean A instantiated.");
                    document.getElementById('placeholder-a').style.borderColor = '#ef6c00';
                    document.getElementById('placeholder-a').innerText = "A (Raw)";
                }
            },
            {
                desc: "Bean A Factory is added to Level 3 Cache (`singletonFactories`). This exposes A early.",
                action: () => {
                    log("addSingletonFactory(A) -> Level 3 Cache.");
                    moveBean('A', 3);
                }
            },
            {
                desc: "Populate Bean A properties. A needs B.",
                action: () => {
                    log("Populating A... Detected dependency: B.");
                    document.getElementById('dep-a-b').style.opacity = 1;
                    document.getElementById('text-a-b').style.opacity = 1;
                    log("Client calls getBean('B').");
                }
            },
            {
                desc: "Bean B is instantiated.",
                action: () => {
                    log("Bean B instantiated.");
                    document.getElementById('placeholder-b').style.borderColor = '#ef6c00';
                    document.getElementById('placeholder-b').innerText = "B (Raw)";
                }
            },
            {
                desc: "Bean B Factory is added to Level 3 Cache.",
                action: () => {
                    log("addSingletonFactory(B) -> Level 3 Cache.");
                    moveBean('B', 3);
                }
            },
            {
                desc: "Populate Bean B properties. B needs A.",
                action: () => {
                    log("Populating B... Detected dependency: A.");
                    document.getElementById('dep-b-a').style.opacity = 1;
                    document.getElementById('text-b-a').style.opacity = 1;
                    log("Client calls getBean('A').");
                }
            },
            {
                desc: "Resolve A for B. Check Caches.",
                action: () => {
                    log("Checking Level 1... No.");
                    log("Checking Level 2... No.");
                    log("Checking Level 3... Found A's Factory!");
                }
            },
            {
                desc: "Promote A: Call Factory, move to Level 2 (`earlySingletonObjects`), remove from Level 3.",
                action: () => {
                    log("Calling A's Factory -> Object A.");
                    log("Moving A: Level 3 -> Level 2.");
                    moveBean('A', 2);
                }
            },
            {
                desc: "Inject A (from Level 2) into B. B initialization completes.",
                action: () => {
                    log("Injecting A (Early Ref) into B.");
                    log("B initialized.");
                    log("Moving B: Level 3 -> Level 1 (Ready).");
                    moveBean('B', 1);
                    document.getElementById('placeholder-b').style.borderColor = '#0288d1';
                    document.getElementById('placeholder-b').innerText = "B (Done)";
                }
            },
            {
                desc: "Return B to A. A initialization completes.",
                action: () => {
                    log("Returning B to A.");
                    log("Injecting B into A.");
                    log("A initialized.");
                    log("Moving A: Level 2 -> Level 1 (Ready).");
                    moveBean('A', 1);
                    document.getElementById('placeholder-a').style.borderColor = '#0288d1';
                    document.getElementById('placeholder-a').innerText = "A (Done)";
                }
            },
            {
                desc: "Done! Both beans are ready in Singleton Pool.",
                action: () => {
                    log("Circular dependency resolved successfully.");
                    document.getElementById('btn-next').disabled = true;
                }
            }
        ];

        function nextStep() {
            if (step < steps.length) {
                steps[step].action();
                step++;
            }
        }

        function reset() {
            step = 0;
            logEl.innerHTML = '';
            document.getElementById('content-1').innerHTML = '';
            document.getElementById('content-2').innerHTML = '';
            document.getElementById('content-3').innerHTML = '';
            document.getElementById('placeholder-a').style.borderColor = '#ccc';
            document.getElementById('placeholder-a').innerText = 'A';
            document.getElementById('placeholder-b').style.borderColor = '#ccc';
            document.getElementById('placeholder-b').innerText = 'B';
            document.getElementById('dep-a-b').style.opacity = 0;
            document.getElementById('text-a-b').style.opacity = 0;
            document.getElementById('dep-b-a').style.opacity = 0;
            document.getElementById('text-b-a').style.opacity = 0;
            document.getElementById('btn-next').disabled = false;
            log("Ready to start.");
        }

        reset();

    </script>
</body>
</html>