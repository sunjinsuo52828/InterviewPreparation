<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL MVCC Visualization</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #00695c; margin-bottom: 10px; }
        
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; flex-wrap: wrap; justify-content: center; }
        
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
        .panel h2 { margin-top: 0; color: #455a64; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.2rem; }

        /* Database Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9rem; }
        th { background: #e0f2f1; color: #00695c; }
        .hidden-col { color: #999; font-style: italic; font-size: 0.8rem; }
        
        /* Undo Log */
        .undo-chain { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .undo-node { 
            background: #fff3e0; border: 1px solid #ffb74d; padding: 10px; border-radius: 6px; 
            position: relative; font-size: 0.85rem;
        }
        .undo-node::after {
            content: 'â†“'; position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); color: #ff9800; font-weight: bold;
        }
        .undo-node:last-child::after { content: ''; }

        /* Transaction Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-start { background: #4caf50; color: white; }
        .btn-update { background: #ff9800; color: white; }
        .btn-commit { background: #2196f3; color: white; }
        .btn-read { background: #9c27b0; color: white; }
        .btn-theory { background: #607d8b; color: white; margin-left: auto; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Read View Box */
        .read-view { background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px; font-family: monospace; font-size: 0.9rem; color: #1565c0; }

        /* Log */
        .log-panel { width: 100%; max-width: 1200px; margin-top: 20px; background: #263238; color: #eceff1; padding: 15px; border-radius: 8px; font-family: monospace; height: 150px; overflow-y: auto; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #37474f; }
        .log-hl { color: #80cbc4; font-weight: bold; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 8px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; }

    </style>
</head>
<body>

    <h1>MySQL MVCC Visualization (InnoDB)</h1>

    <div class="controls">
        <button class="btn-start" onclick="startTx()">Start New Transaction</button>
        <button class="btn-update" onclick="updateRow()" id="btn-update" disabled>Update Row (id=1)</button>
        <button class="btn-commit" onclick="commitTx()" id="btn-commit" disabled>Commit</button>
        <button class="btn-read" onclick="readRow()" id="btn-read" disabled>Select * (Snapshot Read)</button>
        <button class="btn-theory" onclick="openModal()">ðŸ“š Deep Dive</button>
    </div>

    <div class="container">
        <!-- Current Data Panel -->
        <div class="panel">
            <h2>Current Table (Clustered Index)</h2>
            <table id="main-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th class="hidden-col">DB_TRX_ID</th>
                        <th class="hidden-col">DB_ROLL_PTR</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows go here -->
                </tbody>
            </table>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">
                * DB_TRX_ID: Last transaction ID that modified this row.<br>
                * DB_ROLL_PTR: Pointer to the Undo Log record.
            </div>
        </div>

        <!-- Undo Log Panel -->
        <div class="panel">
            <h2>Undo Log (Version Chain)</h2>
            <div class="undo-chain" id="undo-log">
                <div style="color:#999; text-align:center;">(Empty)</div>
            </div>
        </div>

        <!-- Transaction Context Panel -->
        <div class="panel">
            <h2>Current Transaction Context</h2>
            <div id="tx-status">No active transaction.</div>
            <div id="read-view-box" class="read-view" style="display:none;">
                <strong>Read View:</strong><br>
                m_ids: []<br>
                min_trx_id: -<br>
                max_trx_id: -<br>
                creator_trx_id: -
            </div>
        </div>
    </div>

    <div class="log-panel" id="log">
        <div class="log-line">> System initialized. Initial row inserted (Trx 1).</div>
    </div>

    <!-- Deep Dive Modal -->
    <div id="theory-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('theory-modal').style.display='none'">&times;</span>
            <h2 style="color:#00695c;">MySQL MVCC Deep Dive</h2>
            
            <h3>1. What is MVCC?</h3>
            <p>Multi-Version Concurrency Control allows MySQL (InnoDB) to handle multiple transactions simultaneously without locking rows for reading. It keeps multiple versions of data.</p>

            <h3>2. Hidden Columns</h3>
            <ul>
                <li><strong>DB_TRX_ID:</strong> The ID of the transaction that last modified the row.</li>
                <li><strong>DB_ROLL_PTR:</strong> A pointer (address) to the previous version of this row in the Undo Log.</li>
            </ul>

            <h3>3. Read View (The "Snapshot")</h3>
            <p>When a transaction performs a read (in Repeatable Read), it creates a Read View containing:</p>
            <ul>
                <li><code>m_ids</code>: List of active (uncommitted) transactions at that moment.</li>
                <li><code>min_trx_id</code>: The smallest active transaction ID.</li>
                <li><code>max_trx_id</code>: The next transaction ID to be assigned.</li>
            </ul>

            <h3>4. Visibility Rules</h3>
            <p>When checking a row version with <code>trx_id</code>:</p>
            <ol>
                <li>If <code>trx_id < min_trx_id</code>: Visible (Committed before we started).</li>
                <li>If <code>trx_id >= max_trx_id</code>: Invisible (Started after we took snapshot).</li>
                <li>If <code>trx_id</code> is in <code>m_ids</code>: Invisible (Was active/uncommitted when we started).</li>
                <li>Else: Visible.</li>
            </ol>
            <p>If a row is invisible, InnoDB follows the <code>DB_ROLL_PTR</code> to the Undo Log to find an older, visible version.</p>
        </div>
    </div>

    <script>
        // Global State
        let globalTrxId = 100;
        let currentTx = null;
        
        // Initial Data
        let rowData = {
            id: 1,
            name: 'Alice',
            trx_id: 1, // Initial committed transaction
            roll_ptr: null
        };

        // Undo Log (Array of objects)
        let undoLog = [];

        function init() {
            renderTable();
        }

        function log(msg) {
            const div = document.getElementById('log');
            div.innerHTML += `<div class="log-line">${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        function openModal() { document.getElementById('theory-modal').style.display = 'flex'; }
        function closeModal(e) { if(e.target.className === 'modal-overlay') document.getElementById('theory-modal').style.display = 'none'; }

        function renderTable() {
            const tbody = document.querySelector('#main-table tbody');
            tbody.innerHTML = `
                <tr style="background: #e8f5e9;">
                    <td>${rowData.id}</td>
                    <td>${rowData.name}</td>
                    <td class="hidden-col">${rowData.trx_id}</td>
                    <td class="hidden-col">${rowData.roll_ptr ? '0x' + rowData.roll_ptr.toString(16) : 'NULL'}</td>
                </tr>
            `;
        }

        function renderUndoLog() {
            const container = document.getElementById('undo-log');
            if (undoLog.length === 0) {
                container.innerHTML = '<div style="color:#999; text-align:center;">(Empty)</div>';
                return;
            }
            
            let html = '';
            // Show newest first
            for (let i = undoLog.length - 1; i >= 0; i--) {
                const rec = undoLog[i];
                html += `
                    <div class="undo-node">
                        <strong>Addr: 0x${rec.addr.toString(16)}</strong><br>
                        Name: ${rec.name}<br>
                        Trx_ID: ${rec.trx_id}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function startTx() {
            if (currentTx) {
                alert("Please commit the current transaction first.");
                return;
            }
            currentTx = {
                id: globalTrxId++,
                readView: null // Created on first read
            };
            
            document.getElementById('tx-status').innerHTML = `
                <strong>Active Transaction ID: ${currentTx.id}</strong><br>
                Status: Running
            `;
            
            document.getElementById('btn-update').disabled = false;
            document.getElementById('btn-commit').disabled = false;
            document.getElementById('btn-read').disabled = false;
            
            log(`> Transaction ${currentTx.id} started.`);
        }

        function updateRow() {
            if (!currentTx) return;
            
            const newName = prompt("Enter new name for ID=1:", "Bob");
            if (!newName) return;

            // 1. Create Undo Log Record (Copy current state)
            const undoRecord = {
                addr: Date.now(), // Fake address
                id: rowData.id,
                name: rowData.name,
                trx_id: rowData.trx_id,
                roll_ptr: rowData.roll_ptr // Point to previous version
            };
            undoLog.push(undoRecord);

            // 2. Update Current Row
            const oldName = rowData.name;
            rowData.name = newName;
            rowData.trx_id = currentTx.id;
            rowData.roll_ptr = undoRecord.addr;

            renderTable();
            renderUndoLog();
            log(`> Tx ${currentTx.id} updated ID=1: "${oldName}" -> "${newName}". Undo log created.`);
        }

        function commitTx() {
            if (!currentTx) return;
            log(`> Transaction ${currentTx.id} committed.`);
            currentTx = null;
            document.getElementById('tx-status').innerText = "No active transaction.";
            document.getElementById('read-view-box').style.display = 'none';
            
            document.getElementById('btn-update').disabled = true;
            document.getElementById('btn-commit').disabled = true;
            document.getElementById('btn-read').disabled = true;
        }

        function readRow() {
            if (!currentTx) return;

            // Create Read View if not exists (Repeatable Read behavior)
            if (!currentTx.readView) {
                // Simplified Read View generation
                // In real InnoDB, m_ids includes all active trx. 
                // Here we simplify: if we are the only active one, m_ids is just us? 
                // Actually, let's simulate a scenario.
                // Let's assume there is another hypothetical active transaction 999 just for demo?
                // No, let's stick to strict logic.
                
                currentTx.readView = {
                    m_ids: [currentTx.id], // We are active
                    min_trx_id: currentTx.id,
                    max_trx_id: globalTrxId, // Next ID
                    creator_trx_id: currentTx.id
                };
                
                const rv = currentTx.readView;
                document.getElementById('read-view-box').style.display = 'block';
                document.getElementById('read-view-box').innerHTML = `
                    <strong>Read View Created!</strong><br>
                    m_ids: [${rv.m_ids.join(', ')}]<br>
                    min_trx_id: ${rv.min_trx_id}<br>
                    max_trx_id: ${rv.max_trx_id}<br>
                    creator_trx_id: ${rv.creator_trx_id}
                `;
                log(`> Tx ${currentTx.id} created Read View.`);
            }

            // Perform Visibility Check
            let visibleVersion = null;
            let currentCheck = rowData; // Start from main table
            
            // Traverse chain
            while (currentCheck) {
                if (checkVisibility(currentCheck, currentTx.readView)) {
                    visibleVersion = currentCheck;
                    break;
                }
                // Follow pointer
                if (currentCheck.roll_ptr) {
                    currentCheck = undoLog.find(u => u.addr === currentCheck.roll_ptr);
                } else {
                    currentCheck = null;
                }
            }

            if (visibleVersion) {
                alert(`Read Result: ID=${visibleVersion.id}, Name="${visibleVersion.name}"\n(Version from Trx ${visibleVersion.trx_id})`);
                log(`> Tx ${currentTx.id} read ID=1. Result: "${visibleVersion.name}".`);
            } else {
                alert("No visible version found.");
            }
        }

        function checkVisibility(row, rv) {
            const trx_id = row.trx_id;
            
            // 1. If I created it, I can see it
            if (trx_id === rv.creator_trx_id) return true;

            // 2. If trx_id < min_trx_id, it was committed before I started -> Visible
            if (trx_id < rv.min_trx_id) return true;

            // 3. If trx_id >= max_trx_id, it started after I created Read View -> Invisible
            if (trx_id >= rv.max_trx_id) return false;

            // 4. If trx_id in m_ids, it was active when I started -> Invisible
            if (rv.m_ids.includes(trx_id)) return false;

            return true; // Otherwise visible
        }

        init();

    </script>
</body>
</html>