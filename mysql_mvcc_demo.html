<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL MVCC å¯è§†åŒ–æ¼”ç¤º</title>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { color: #00695c; }
        
        .container { display: flex; gap: 20px; width: 1100px; margin-top: 20px; }
        
        .col { display: flex; flex-direction: column; gap: 15px; }
        .col-left { width: 300px; }
        .col-center { width: 400px; }
        .col-right { width: 350px; }

        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .trx-panel { display: flex; flex-direction: column; gap: 10px; }
        .trx-row { display: flex; align-items: center; justify-content: space-between; background: #e0f2f1; padding: 10px; border-radius: 4px; }
        .trx-status { font-weight: bold; font-size: 0.9rem; }
        .trx-active { color: #009688; }
        .trx-committed { color: #757575; }

        button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .btn-start { background: #4caf50; }
        .btn-update { background: #2196f3; }
        .btn-commit { background: #ff9800; }
        .btn-read { background: #9c27b0; }

        .undo-log-chain { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .version-record { 
            width: 100%; background: #fff3e0; border: 1px solid #ffb74d; padding: 10px; border-radius: 4px; position: relative;
            transition: all 0.3s;
        }
        .version-record.latest { background: #e8f5e9; border-color: #81c784; }
        .version-meta { font-size: 0.8rem; color: #666; display: flex; justify-content: space-between; }
        .version-data { font-size: 1.1rem; font-weight: bold; margin: 5px 0; text-align: center; }
        .roll-ptr { text-align: center; font-size: 1.2rem; color: #999; line-height: 0.8; }

        .log-console {
            width: 100%; background: #212121; color: #00e676; padding: 10px; border-radius: 8px; 
            font-family: 'Consolas', monospace; height: 300px; overflow-y: auto; font-size: 0.85rem;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; }
        .log-hl { color: #ffeb3b; }

        .read-view-box { background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9rem; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
        }
        .close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #666;
        }
    </style>
</head>
<body>
    <h1>MySQL MVCC å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æ¼”ç¤º</h1>
    
    <div style="width: 1100px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <strong>éš”ç¦»çº§åˆ« (Isolation Level):</strong>
            <select id="isolation-level" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="RR">Repeatable Read (å¯é‡å¤è¯» - é»˜è®¤)</option>
                <option value="RC">Read Committed (è¯»å·²æäº¤)</option>
            </select>
        </div>
        <button onclick="openModal()" style="background: #00695c;">ğŸ“– æ·±åº¦è§£æ: Read View åŸç†</button>
    </div>

    <!-- Modal -->
    <div id="deep-dive-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('deep-dive-modal').style.display='none'">&times;</span>
            <h2 style="color:#00695c; margin-top:0;">ğŸ¤” æ·±åº¦è§£æ: MVCC å¯è§æ€§ç®—æ³•</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <strong>1. ä»€ä¹ˆæ˜¯ Read View?</strong>
                    <p>Read View æ˜¯äº‹åŠ¡è¿›è¡Œå¿«ç…§è¯»æ—¶äº§ç”Ÿçš„è¯»è§†å›¾ã€‚åŒ…å«å››ä¸ªæ ¸å¿ƒå­—æ®µï¼š</p>
                    <ul style="background:#f5f5f5; padding:10px 20px; border-radius:4px;">
                        <li><code>m_ids</code>: ç”Ÿæˆæ—¶åˆ»æ‰€æœ‰<strong>æ´»è·ƒ</strong>äº‹åŠ¡çš„ ID åˆ—è¡¨ã€‚</li>
                        <li><code>min_id</code>: æ´»è·ƒäº‹åŠ¡ä¸­æœ€å°çš„ IDã€‚</li>
                        <li><code>max_id</code>: ä¸‹ä¸€ä¸ªå°†è¢«åˆ†é…çš„äº‹åŠ¡ ID (å½“å‰æœ€å¤§ID + 1)ã€‚</li>
                        <li><code>creator_id</code>: åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡ IDã€‚</li>
                    </ul>
                </div>
                <div>
                    <strong>2. å¯è§æ€§åˆ¤æ–­è§„åˆ™ (Visibility Rules)</strong>
                    <p>å¯¹äº Undo Log ä¸­çš„æ¯ä¸€ä¸ªç‰ˆæœ¬ (trx_id)ï¼Œåˆ¤æ–­æ˜¯å¦å¯è§ï¼š</p>
                    <ul style="font-size: 0.9rem;">
                        <li>âœ… <strong>å¯è§:</strong> <code>trx_id == creator_id</code> (è‡ªå·±æ”¹çš„)</li>
                        <li>âœ… <strong>å¯è§:</strong> <code>trx_id < min_id</code> (ç”Ÿæˆ View å‰å·²æäº¤)</li>
                        <li>âŒ <strong>ä¸å¯è§:</strong> <code>trx_id >= max_id</code> (ç”Ÿæˆ View åæ‰å¼€å¯)</li>
                        <li>âŒ <strong>ä¸å¯è§:</strong> <code>trx_id in m_ids</code> (ç”Ÿæˆ View æ—¶è¿˜æœªæäº¤)</li>
                        <li>âœ… <strong>å¯è§:</strong> <code>trx_id</code> åœ¨ <code>min</code> å’Œ <code>max</code> ä¹‹é—´ï¼Œä¸”ä¸åœ¨ <code>m_ids</code> ä¸­ (ç”Ÿæˆ View å‰å·²æäº¤)</li>
                    </ul>
                </div>
                <div style="grid-column: span 2; border-top: 1px solid #eee; padding-top: 10px;">
                    <strong>3. RC vs RR çš„åŒºåˆ«</strong>
                    <ul>
                        <li><strong>Read Committed (RC):</strong> æ¯æ¬¡ <code>SELECT</code> éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Read Viewã€‚èƒ½è¯»åˆ°åˆ«çš„äº‹åŠ¡åˆšæäº¤çš„æ•°æ®ã€‚</li>
                        <li><strong>Repeatable Read (RR):</strong> åªæœ‰ç¬¬ä¸€æ¬¡ <code>SELECT</code> ç”Ÿæˆ Read Viewï¼Œåç»­å¤ç”¨ã€‚ä¿è¯åŒä¸€ä¸ªäº‹åŠ¡å†…è¯»å–ä¸€è‡´ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Left: Transactions -->
        <div class="col col-left">
            <div class="card">
                <h3>æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ (Active Trx)</h3>
                <div id="trx-list" class="trx-panel">
                    <!-- Trx items injected here -->
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn-start" onclick="startTrx()">å¼€å¯æ–°äº‹åŠ¡ (Start)</button>
                </div>
            </div>
            
            <div class="card">
                <h3>å½“å‰ Read View è§„åˆ™</h3>
                <div style="font-size: 0.85rem; color: #555;">
                    <p><strong>m_ids:</strong> æ´»è·ƒäº‹åŠ¡ ID åˆ—è¡¨</p>
                    <p><strong>min_id:</strong> æœ€å°æ´»è·ƒ ID</p>
                    <p><strong>max_id:</strong> ä¸‹ä¸€ä¸ªåˆ†é… ID</p>
                    <hr>
                    <p>1. trx_id < min_id: <span style="color:green">å¯è§</span> (å·²æäº¤)</p>
                    <p>2. trx_id >= max_id: <span style="color:red">ä¸å¯è§</span> (æœªæ¥äº‹åŠ¡)</p>
                    <p>3. trx_id in m_ids: <span style="color:red">ä¸å¯è§</span> (æ´»è·ƒä¸­)</p>
                </div>
            </div>
        </div>

        <!-- Center: Undo Log Chain -->
        <div class="col col-center">
            <div class="card">
                <h3>Undo Log ç‰ˆæœ¬é“¾ (Row History)</h3>
                <div id="undo-log" class="undo-log-chain">
                    <!-- Versions injected here -->
                </div>
            </div>
        </div>

        <!-- Right: Log & Read -->
        <div class="col col-right">
            <div class="card">
                <h3>æ“ä½œæ—¥å¿— (Operation Log)</h3>
                <div class="log-console" id="log">
                    <div class="log-entry">> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆã€‚åˆå§‹è¡Œ: id=1, name="Alice" (trx_id=0)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalTrxId = 100;
        let transactions = []; // { id, status: 'ACTIVE'|'COMMITTED', snapshot: null }
        
        // The Row History
        let rowVersions = [
            { trx_id: 0, value: "Alice", roll_ptr: null }
        ];

        function openModal() { document.getElementById('deep-dive-modal').style.display = 'flex'; }
        function closeModal(e) { if(e.target.className==='modal-overlay') document.getElementById('deep-dive-modal').style.display='none'; }

        function log(msg, highlight=false) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            if(highlight) div.classList.add('log-hl');
            div.innerHTML = `> ${msg}`;
            const console = document.getElementById('log');
            console.appendChild(div);
            console.scrollTop = console.scrollHeight;
        }

        function startTrx() {
            const id = globalTrxId++;
            transactions.push({ id, status: 'ACTIVE', snapshot: null });
            renderTrx();
            log(`äº‹åŠ¡ <span style="color:#4caf50">TRX_${id}</span> å·²å¼€å¯ã€‚`);
        }

        function commitTrx(id) {
            const trx = transactions.find(t => t.id === id);
            if(trx && trx.status === 'ACTIVE') {
                trx.status = 'COMMITTED';
                renderTrx();
                log(`äº‹åŠ¡ <span style="color:#ff9800">TRX_${id}</span> å·²æäº¤ (Committed)ã€‚`);
            }
        }

        function updateRow(id) {
            const trx = transactions.find(t => t.id === id);
            if(!trx || trx.status !== 'ACTIVE') return;

            const newValue = prompt(`TRX_${id}: å°† name ä¿®æ”¹ä¸º?`, "Bob");
            if(!newValue) return;

            // Create new version
            const latest = rowVersions[0];
            const newVersion = {
                trx_id: id,
                value: newValue,
                roll_ptr: latest // Point to previous
            };
            
            rowVersions.unshift(newVersion); // Add to top
            renderUndoLog();
            log(`TRX_${id} æ›´æ–°äº†è¡Œã€‚æ–°å€¼: "${newValue}"ã€‚å·²æ·»åŠ åˆ° Undo Logã€‚`);
        }

        function readRow(id) {
            const trx = transactions.find(t => t.id === id);
            if(!trx) return;

            const isolation = document.getElementById('isolation-level').value;
            let readView = trx.snapshot;

            // RC: Always create new. RR: Create only if null.
            if (isolation === 'RC' || !readView) {
                const activeIds = transactions.filter(t => t.status === 'ACTIVE').map(t => t.id);
                readView = {
                    m_ids: activeIds,
                    min_id: activeIds.length > 0 ? Math.min(...activeIds) : globalTrxId,
                    max_id: globalTrxId,
                    creator_id: id
                };
                
                if (isolation === 'RR') {
                    trx.snapshot = readView; // Save for RR
                    log(`TRX_${id} (RR) ç”Ÿæˆ Read View: [min=${readView.min_id}, max=${readView.max_id}, active=${JSON.stringify(readView.m_ids)}]`);
                } else {
                    log(`TRX_${id} (RC) ç”Ÿæˆæ–° Read View: [min=${readView.min_id}, max=${readView.max_id}, active=${JSON.stringify(readView.m_ids)}]`);
                }
            } else {
                log(`TRX_${id} (RR) å¤ç”¨æ—§ Read Viewã€‚`);
            }

            // Traverse Undo Log
            let visibleVersion = null;
            for(let v of rowVersions) {
                if(checkVisibility(v.trx_id, readView)) {
                    visibleVersion = v;
                    break;
                }
            }

            if(visibleVersion) {
                alert(`TRX_${id} è¯»å–ç»“æœ: "${visibleVersion.value}" (æ¥è‡ª TRX_${visibleVersion.trx_id})`);
                log(`TRX_${id} è¯»å–ç»“æœ: <span style="color:#00e676">"${visibleVersion.value}"</span> (ç‰ˆæœ¬ TRX_${visibleVersion.trx_id})`, true);
            } else {
                alert("æœªæ‰¾åˆ°å¯è§ç‰ˆæœ¬!");
            }
        }

        function checkVisibility(trx_id, view) {
            // 1. If current trx created it, visible
            if(trx_id === view.creator_id) return true;

            // 2. If trx_id < min_id, committed before view creation -> Visible
            if(trx_id < view.min_id) return true;

            // 3. If trx_id >= max_id, created after view -> Invisible
            if(trx_id >= view.max_id) return false;

            // 4. If in m_ids, active when view created -> Invisible
            if(view.m_ids.includes(trx_id)) return false;

            // Else (between min and max, but not active) -> Committed -> Visible
            return true;
        }

        function renderTrx() {
            const container = document.getElementById('trx-list');
            container.innerHTML = '';
            transactions.forEach(t => {
                const div = document.createElement('div');
                div.className = 'trx-row';
                div.innerHTML = `
                    <div>
                        <div class="trx-status ${t.status === 'ACTIVE' ? 'trx-active' : 'trx-committed'}">TRX_${t.id}</div>
                        <div style="font-size:0.8rem">${t.status}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        ${t.status === 'ACTIVE' ? `
                            <button class="btn-update" onclick="updateRow(${t.id})">æ”¹</button>
                            <button class="btn-read" onclick="readRow(${t.id})">è¯»</button>
                            <button class="btn-commit" onclick="commitTrx(${t.id})">äº¤</button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderUndoLog() {
            const container = document.getElementById('undo-log');
            container.innerHTML = '';
            rowVersions.forEach((v, idx) => {
                const div = document.createElement('div');
                div.className = 'version-record';
                if(idx === 0) div.classList.add('latest');
                
                div.innerHTML = `
                    <div class="version-meta">
                        <span>TRX_ID: ${v.trx_id}</span>
                        <span>${idx === 0 ? '(æœ€æ–°)' : ''}</span>
                    </div>
                    <div class="version-data">name = "${v.value}"</div>
                `;
                container.appendChild(div);

                if(idx < rowVersions.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'roll-ptr';
                    arrow.innerHTML = 'â†“<br><span style="font-size:0.8rem">roll_ptr</span>';
                    container.appendChild(arrow);
                }
            });
        }

        // Init
        renderUndoLog();
        startTrx(); // Start 100
    </script>
</body>
</html>