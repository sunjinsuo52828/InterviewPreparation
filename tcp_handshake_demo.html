<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP 3-Way Handshake Visualization</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #263238; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { color: #4fc3f7; margin-bottom: 10px; }

        .container { display: flex; justify-content: space-between; width: 800px; margin-top: 40px; position: relative; height: 400px; }
        
        .host { width: 200px; display: flex; flex-direction: column; align-items: center; z-index: 2; }
        .host-icon { font-size: 3rem; margin-bottom: 10px; }
        .host-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .state-box { 
            background: #37474f; padding: 10px 20px; border-radius: 8px; border: 2px solid #546e7a; 
            min-width: 120px; text-align: center; transition: all 0.3s;
        }
        .state-box.active { border-color: #00e676; color: #00e676; box-shadow: 0 0 15px rgba(0, 230, 118, 0.3); }

        .timeline { position: absolute; top: 100px; bottom: 0; width: 2px; background: #546e7a; z-index: 1; }
        .timeline.left { left: 100px; }
        .timeline.right { right: 100px; }

        .packet-area { flex: 1; position: relative; }
        
        .packet {
            position: absolute; top: 50px; left: 100px; /* Start at client */
            background: #ff9800; color: black; padding: 8px 15px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem; opacity: 0; transition: all 1s ease-in-out;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5); z-index: 10;
        }

        .controls { margin-top: 20px; display: flex; gap: 15px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .btn-step { background: #0288d1; color: white; }
        .btn-step:disabled { background: #546e7a; cursor: not-allowed; opacity: 0.5; }
        .btn-reset { background: #d32f2f; color: white; }
        .btn-theory { background: #7b1fa2; color: white; }

        .info-panel {
            margin-top: 30px; background: #37474f; padding: 20px; border-radius: 8px; width: 800px;
            font-family: monospace; color: #b0bec5; min-height: 100px;
        }
        .log-entry { margin-bottom: 5px; }
        .highlight { color: #ff9800; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; color: #333; width: 700px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 8px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; }
        .modal-content h2 { color: #0277bd; }
        .modal-content h3 { color: #ef6c00; margin-top: 20px; }

    </style>
</head>
<body>

    <h1>TCP 3-Way Handshake</h1>

    <div class="container">
        <!-- Client -->
        <div class="host">
            <div class="host-icon">üíª</div>
            <div class="host-name">Client</div>
            <div class="state-box" id="client-state">CLOSED</div>
        </div>
        <div class="timeline left"></div>

        <!-- Packet Animation Area -->
        <div class="packet-area">
            <div class="packet" id="packet">SYN</div>
        </div>

        <div class="timeline right"></div>
        <!-- Server -->
        <div class="host">
            <div class="host-icon">üñ•Ô∏è</div>
            <div class="host-name">Server</div>
            <div class="state-box" id="server-state">LISTEN</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-step" id="btn-step" onclick="nextStep()">Start Handshake</button>
        <button class="btn-reset" onclick="reset()">Reset</button>
        <button class="btn-theory" onclick="openModal()">üìö Deep Dive</button>
    </div>

    <div class="info-panel" id="log">
        <div class="log-entry">> Ready. Server is in LISTEN state.</div>
    </div>

    <!-- Deep Dive Modal -->
    <div id="theory-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('theory-modal').style.display='none'">&times;</span>
            <h2>TCP Handshake Deep Dive</h2>
            
            <h3>1. The Goal</h3>
            <p>To establish a reliable connection where both parties know that the other is ready to send and receive data, and to synchronize Initial Sequence Numbers (ISN).</p>

            <h3>2. The 3 Steps</h3>
            <ul>
                <li><strong>SYN:</strong> Client sends "I want to connect" (seq=x).</li>
                <li><strong>SYN-ACK:</strong> Server says "I hear you (ack=x+1), and I want to connect too (seq=y)".</li>
                <li><strong>ACK:</strong> Client says "I hear you too (ack=y+1)". Connection Established.</li>
            </ul>

            <h3>3. Why 3 steps, not 2?</h3>
            <p>To prevent old duplicate connection initiations from confusing the server. If an old SYN arrives late, the server sends SYN-ACK. If the client didn't request it recently, it sends RST (Reset) to cancel. With only 2 steps, the server might open a connection for a dead client.</p>

            <h3>4. Why Random Sequence Numbers?</h3>
            <p>To prevent "TCP Sequence Prediction Attacks" where an attacker could inject malicious packets into a connection if they could guess the sequence numbers.</p>
        </div>
    </div>

    <script>
        let step = 0;
        const clientState = document.getElementById('client-state');
        const serverState = document.getElementById('server-state');
        const packet = document.getElementById('packet');
        const btnStep = document.getElementById('btn-step');
        const logDiv = document.getElementById('log');

        // Random Sequence Numbers
        const seqX = 1000;
        const seqY = 5000;

        function log(msg) {
            logDiv.innerHTML += `<div class="log-entry">${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function openModal() { document.getElementById('theory-modal').style.display = 'flex'; }
        function closeModal(e) { if(e.target.className === 'modal-overlay') document.getElementById('theory-modal').style.display = 'none'; }

        function reset() {
            step = 0;
            clientState.innerText = "CLOSED";
            clientState.className = "state-box";
            serverState.innerText = "LISTEN";
            serverState.className = "state-box";
            packet.style.opacity = 0;
            packet.style.top = "50px";
            packet.style.left = "100px"; // Reset to left
            btnStep.innerText = "Start Handshake";
            btnStep.disabled = false;
            logDiv.innerHTML = '<div class="log-entry">> Ready. Server is in LISTEN state.</div>';
        }

        function nextStep() {
            btnStep.disabled = true;

            if (step === 0) {
                // Step 1: Client sends SYN
                log(`> [Step 1] Client sends <strong>SYN</strong> (seq=${seqX}).`);
                clientState.innerText = "SYN_SENT";
                clientState.classList.add('active');
                
                packet.innerText = `SYN (seq=${seqX})`;
                packet.style.opacity = 1;
                packet.style.top = "100px";
                
                // Animate Left -> Right
                packet.style.left = "100px";
                setTimeout(() => {
                    packet.style.left = "calc(100% - 180px)"; // Move to right
                }, 50);

                setTimeout(() => {
                    log(`> Server receives SYN.`);
                    serverState.innerText = "SYN_RCVD";
                    serverState.classList.add('active');
                    btnStep.innerText = "Send SYN-ACK";
                    btnStep.disabled = false;
                    step++;
                }, 1200);
            } 
            else if (step === 1) {
                // Step 2: Server sends SYN-ACK
                log(`> [Step 2] Server sends <strong>SYN-ACK</strong> (seq=${seqY}, ack=${seqX+1}).`);
                
                packet.innerText = `SYN-ACK (seq=${seqY}, ack=${seqX+1})`;
                packet.style.top = "200px";
                
                // Animate Right -> Left
                packet.style.left = "calc(100% - 180px)";
                setTimeout(() => {
                    packet.style.left = "100px"; // Move to left
                }, 50);

                setTimeout(() => {
                    log(`> Client receives SYN-ACK.`);
                    clientState.innerText = "ESTABLISHED";
                    clientState.style.borderColor = "#00e676";
                    clientState.style.background = "#1b5e20";
                    btnStep.innerText = "Send ACK";
                    btnStep.disabled = false;
                    step++;
                }, 1200);
            }
            else if (step === 2) {
                // Step 3: Client sends ACK
                log(`> [Step 3] Client sends <strong>ACK</strong> (seq=${seqX+1}, ack=${seqY+1}).`);
                
                packet.innerText = `ACK (seq=${seqX+1}, ack=${seqY+1})`;
                packet.style.top = "300px";
                
                // Animate Left -> Right
                packet.style.left = "100px";
                setTimeout(() => {
                    packet.style.left = "calc(100% - 180px)"; // Move to right
                }, 50);

                setTimeout(() => {
                    log(`> Server receives ACK.`);
                    serverState.innerText = "ESTABLISHED";
                    serverState.style.borderColor = "#00e676";
                    serverState.style.background = "#1b5e20";
                    log(`<span style="color:#00e676; font-weight:bold;">> Connection Established! üöÄ</span>`);
                    btnStep.innerText = "Done";
                    packet.style.opacity = 0;
                    step++;
                }, 1200);
            }
        }

    </script>
</body>
</html>