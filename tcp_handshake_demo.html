<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹å¯è§†åŒ–</title>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { color: #1565c0; }

        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: background 0.3s; }
        .btn-connect { background: #4caf50; }
        .btn-connect:hover { background: #43a047; }
        .btn-disconnect { background: #f44336; }
        .btn-disconnect:hover { background: #e53935; }
        .btn-reset { background: #607d8b; }
        .btn-guide { background: #1565c0; }

        .diagram-container {
            display: flex; justify-content: space-between; width: 800px; height: 500px; background: white; 
            padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative;
        }

        .host {
            width: 120px; display: flex; flex-direction: column; align-items: center; z-index: 2;
        }
        .host-icon { font-size: 3rem; margin-bottom: 10px; }
        .host-name { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
        .state-box {
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; color: white;
            transition: all 0.5s; text-align: center; min-width: 100px;
        }
        
        /* States */
        .state-closed { background: #9e9e9e; }
        .state-listen { background: #ff9800; }
        .state-syn-sent { background: #2196f3; }
        .state-syn-rcvd { background: #03a9f4; }
        .state-established { background: #4caf50; box-shadow: 0 0 10px #4caf50; }
        .state-fin-wait-1 { background: #e91e63; }
        .state-fin-wait-2 { background: #ec407a; }
        .state-close-wait { background: #ab47bc; }
        .state-last-ack { background: #8e24aa; }
        .state-time-wait { background: #ffc107; color: #333; }

        /* Timeline */
        .timeline {
            flex-grow: 1; position: relative; margin: 0 20px; border-left: 2px dashed #ddd; border-right: 2px dashed #ddd;
        }
        
        .packet {
            position: absolute; padding: 5px 10px; background: #fff; border: 2px solid #333; border-radius: 4px;
            font-family: 'Consolas', monospace; font-size: 0.85rem; font-weight: bold;
            transform: translate(-50%, -50%); opacity: 0; transition: all 1.5s linear; z-index: 1;
            display: flex; align-items: center; gap: 5px;
        }
        .packet.active { opacity: 1; }
        .flag { padding: 2px 4px; border-radius: 2px; color: white; font-size: 0.7rem; }
        .flag-syn { background: #2196f3; }
        .flag-ack { background: #4caf50; }
        .flag-fin { background: #f44336; }

        .log-panel {
            width: 800px; height: 150px; background: #212121; color: #00e676; margin-top: 20px;
            padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; overflow-y: auto; font-size: 0.9rem;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 700px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #666; }
        
        .concept-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .concept-item { background: #f9f9f9; padding: 10px; border-radius: 4px; border-left: 4px solid #1565c0; }
        .concept-title { font-weight: bold; color: #1565c0; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>TCP åè®®çŠ¶æ€æœºæ¼”ç¤º</h1>

    <div class="controls">
        <button class="btn-connect" onclick="startHandshake()">å»ºç«‹è¿æ¥ (ä¸‰æ¬¡æ¡æ‰‹)</button>
        <button class="btn-disconnect" onclick="startTeardown()">æ–­å¼€è¿æ¥ (å››æ¬¡æŒ¥æ‰‹)</button>
        <button class="btn-reset" onclick="resetState()">é‡ç½® (Reset)</button>
        <button class="btn-guide" onclick="openModal()">ğŸ“– æ·±åº¦è§£æ: ä¸ºä»€ä¹ˆæ˜¯3æ¬¡/4æ¬¡?</button>
    </div>

    <!-- Modal -->
    <div id="deep-dive-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('deep-dive-modal').style.display='none'">&times;</span>
            <h2 style="color:#1565c0; margin-top:0;">TCP æ ¸å¿ƒæœºåˆ¶è§£æ</h2>
            
            <div class="concept-grid">
                <div class="concept-item">
                    <div class="concept-title">ä¸ºä»€ä¹ˆæ¡æ‰‹æ˜¯ 3 æ¬¡?</div>
                    <p>ä¸ºäº†é˜²æ­¢<strong>å·²å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µ</strong>çªç„¶åˆä¼ é€åˆ°äº†æœåŠ¡ç«¯ï¼Œäº§ç”Ÿé”™è¯¯ã€‚ä¸‰æ¬¡æ¡æ‰‹å¯ä»¥ç¡®è®¤åŒæ–¹çš„æ¥æ”¶èƒ½åŠ›å’Œå‘é€èƒ½åŠ›éƒ½æ­£å¸¸ã€‚</p>
                </div>
                <div class="concept-item">
                    <div class="concept-title">ä¸ºä»€ä¹ˆæŒ¥æ‰‹æ˜¯ 4 æ¬¡?</div>
                    <p>TCP æ˜¯å…¨åŒå·¥çš„ã€‚Client å‘é€ FIN åªæ˜¯è¡¨ç¤º"æˆ‘æ²¡æ•°æ®å‘äº†"ï¼Œä½† Server å¯èƒ½è¿˜æœ‰æ•°æ®è¦å‘ã€‚æ‰€ä»¥ Server å…ˆå› ACKï¼Œç­‰å‘å®Œæ•°æ®åå†å‘ FINã€‚</p>
                </div>
                <div class="concept-item">
                    <div class="concept-title">TIME_WAIT çŠ¶æ€</div>
                    <p>Client æ”¶åˆ° Server çš„ FIN åï¼Œå¿…é¡»ç­‰å¾… 2MSL æ—¶é—´ã€‚ç¡®ä¿ Server æ”¶åˆ°æœ€åçš„ ACKã€‚å¦‚æœ ACK ä¸¢äº†ï¼ŒServer ä¼šé‡ä¼  FINã€‚</p>
                </div>
                <div class="concept-item">
                    <div class="concept-title">ISN (åˆå§‹åºåˆ—å·)</div>
                    <p>ISN æ˜¯éšæœºç”Ÿæˆçš„ï¼Œé˜²æ­¢è¢«ä¼ªé€ ï¼Œä¹Ÿé˜²æ­¢æ—§è¿æ¥çš„æŠ¥æ–‡å¹²æ‰°æ–°è¿æ¥ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div class="diagram-container">
        <!-- Client -->
        <div class="host">
            <div class="host-icon">ğŸ’»</div>
            <div class="host-name">Client</div>
            <div id="client-state" class="state-box state-closed">CLOSED</div>
        </div>

        <!-- Animation Area -->
        <div class="timeline" id="timeline">
            <!-- Packets will fly here -->
        </div>

        <!-- Server -->
        <div class="host">
            <div class="host-icon">ğŸ–¥ï¸</div>
            <div class="host-name">Server</div>
            <div id="server-state" class="state-box state-listen">LISTEN</div>
        </div>
    </div>

    <div class="log-panel" id="log">
        <div class="log-entry">> ç³»ç»Ÿå°±ç»ªã€‚Server å¤„äº LISTEN çŠ¶æ€ã€‚</div>
    </div>

    <script>
        const clientStateEl = document.getElementById('client-state');
        const serverStateEl = document.getElementById('server-state');
        const timeline = document.getElementById('timeline');
        const logEl = document.getElementById('log');

        let isAnimating = false;
        let currentState = 'CLOSED'; // Overall logical state

        function openModal() { document.getElementById('deep-dive-modal').style.display = 'flex'; }
        function closeModal(e) { if(e.target.className==='modal-overlay') document.getElementById('deep-dive-modal').style.display='none'; }

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `> ${msg}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setClientState(state, className) {
            clientStateEl.innerText = state;
            clientStateEl.className = `state-box ${className}`;
            log(`Client çŠ¶æ€å˜æ›´ä¸º: ${state}`);
        }

        function setServerState(state, className) {
            serverStateEl.innerText = state;
            serverStateEl.className = `state-box ${className}`;
            log(`Server çŠ¶æ€å˜æ›´ä¸º: ${state}`);
        }

        function resetState() {
            if(isAnimating) return;
            setClientState('CLOSED', 'state-closed');
            setServerState('LISTEN', 'state-listen');
            timeline.innerHTML = '';
            logEl.innerHTML = '<div class="log-entry">> ç³»ç»Ÿå·²é‡ç½®ã€‚</div>';
            currentState = 'CLOSED';
        }

        function createPacket(text, flags, fromLeft) {
            const pkt = document.createElement('div');
            pkt.className = 'packet';
            
            let flagHtml = '';
            if(flags.includes('SYN')) flagHtml += '<span class="flag flag-syn">SYN</span>';
            if(flags.includes('ACK')) flagHtml += '<span class="flag flag-ack">ACK</span>';
            if(flags.includes('FIN')) flagHtml += '<span class="flag flag-fin">FIN</span>';
            
            pkt.innerHTML = `${flagHtml} <span>${text}</span>`;
            
            // Initial Position
            pkt.style.top = '50px'; // Will be dynamic in real app, fixed for simple demo
            pkt.style.left = fromLeft ? '0%' : '100%';
            
            timeline.appendChild(pkt);
            return pkt;
        }

        async function animatePacket(pkt, fromLeft) {
            return new Promise(resolve => {
                // Trigger reflow
                pkt.offsetHeight; 
                pkt.classList.add('active');
                
                // Move
                pkt.style.left = fromLeft ? '100%' : '0%';
                pkt.style.top = '100px'; // Slight arc effect simplified

                setTimeout(() => {
                    pkt.remove();
                    resolve();
                }, 1500);
            });
        }

        async function startHandshake() {
            if(isAnimating || currentState === 'ESTABLISHED') return;
            isAnimating = true;
            log("--- å¼€å§‹ä¸‰æ¬¡æ¡æ‰‹ ---");

            // Step 1: Client sends SYN
            setClientState('SYN_SENT', 'state-syn-sent');
            const p1 = createPacket('seq=x', ['SYN'], true);
            await animatePacket(p1, true);

            // Step 2: Server receives SYN, sends SYN+ACK
            setServerState('SYN_RCVD', 'state-syn-rcvd');
            const p2 = createPacket('seq=y, ack=x+1', ['SYN', 'ACK'], false);
            await animatePacket(p2, false);

            // Step 3: Client receives SYN+ACK, sends ACK
            setClientState('ESTABLISHED', 'state-established');
            const p3 = createPacket('seq=x+1, ack=y+1', ['ACK'], true);
            await animatePacket(p3, true);

            setServerState('ESTABLISHED', 'state-established');
            log("--- è¿æ¥å·²å»ºç«‹ (ESTABLISHED) ---");
            currentState = 'ESTABLISHED';
            isAnimating = false;
        }

        async function startTeardown() {
            if(isAnimating || currentState !== 'ESTABLISHED') {
                if(currentState !== 'ESTABLISHED') alert("è¯·å…ˆå»ºç«‹è¿æ¥!");
                return;
            }
            isAnimating = true;
            log("--- å¼€å§‹å››æ¬¡æŒ¥æ‰‹ ---");

            // Step 1: Client sends FIN
            setClientState('FIN_WAIT_1', 'state-fin-wait-1');
            const p1 = createPacket('seq=u', ['FIN'], true);
            await animatePacket(p1, true);

            // Step 2: Server receives FIN, sends ACK
            setServerState('CLOSE_WAIT', 'state-close-wait');
            const p2 = createPacket('ack=u+1', ['ACK'], false);
            await animatePacket(p2, false);

            // Client receives ACK -> FIN_WAIT_2
            setClientState('FIN_WAIT_2', 'state-fin-wait-2');
            log("Server æ­£åœ¨å¤„ç†å‰©ä½™æ•°æ®...");
            await new Promise(r => setTimeout(r, 1000)); // Simulate data processing

            // Step 3: Server sends FIN
            setServerState('LAST_ACK', 'state-last-ack');
            const p3 = createPacket('seq=w', ['FIN'], false);
            await animatePacket(p3, false);

            // Step 4: Client receives FIN, sends ACK -> TIME_WAIT
            setClientState('TIME_WAIT', 'state-time-wait');
            const p4 = createPacket('ack=w+1', ['ACK'], true);
            await animatePacket(p4, true);

            setServerState('CLOSED', 'state-closed');
            log("Client è¿›å…¥ TIME_WAIT (ç­‰å¾… 2MSL)...");
            
            await new Promise(r => setTimeout(r, 2000)); // Simulate 2MSL
            setClientState('CLOSED', 'state-closed');
            
            log("--- è¿æ¥å·²æ–­å¼€ (CLOSED) ---");
            currentState = 'CLOSED';
            isAnimating = false;
        }
    </script>
</body>
</html>