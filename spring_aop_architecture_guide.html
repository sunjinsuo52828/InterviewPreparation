<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AOP Architecture Guide</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; line-height: 1.6; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #007acc; margin-top: 30px; }
        h3 { color: #555; margin-top: 20px; }
        
        .concept-box { display: flex; gap: 20px; margin: 20px 0; }
        .concept-card { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007acc; }
        .concept-title { font-weight: bold; color: #007acc; margin-bottom: 5px; }
        
        code { background: #f0f0f0; padding: 2px 5px; border-radius: 3px; font-family: 'Consolas', monospace; color: #d63384; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; overflow-x: auto; font-family: 'Consolas', monospace; }
        
        .annotation { color: #dcdcaa; }
        .keyword { color: #569cd6; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .method { color: #dcdcaa; }
        .class-name { color: #4ec9b0; }

        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .comp-col { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; }
        .comp-header { font-weight: bold; text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

        .highlight { background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffeeba; color: #856404; margin: 20px 0; }

        /* --- Simulation Styles --- */
        .sim-container { display: flex; gap: 20px; margin-top: 20px; height: 600px; border-top: 2px solid #eee; padding-top: 20px; }
        .code-panel { flex: 1; background: #1e1e1e; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .tabs { display: flex; background: #252526; }
        .tab { padding: 10px 20px; color: #999; cursor: pointer; font-size: 0.9rem; border-right: 1px solid #333; }
        .tab.active { background: #1e1e1e; color: #fff; border-top: 2px solid #007acc; }
        .code-content { flex: 1; padding: 15px; overflow-y: auto; color: #d4d4d4; font-family: 'Consolas', monospace; font-size: 0.9rem; white-space: pre-wrap; }
        
        .sim-panel { flex: 1; background: #f8f9fa; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #ddd; }
        .form-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .form-item label { display: block; font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .form-item select, .form-item input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-run { padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-run:hover { background: #218838; }

        .flow-diagram { flex: 1; position: relative; background: #fff; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .node { position: absolute; padding: 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; text-align: center; transition: all 0.3s; opacity: 0.5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .node.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px rgba(0,123,255,0.5); }
        .node.error { background: #ffebee; border: 2px solid #d32f2f; color: #d32f2f; }
        .node.success { background: #e8f5e9; border: 2px solid #2e7d32; color: #2e7d32; }

        .client { top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; width: 60px; }
        .proxy-box { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); width: 250px; height: 220px; border: 2px dashed #673ab7; border-radius: 10px; background: #f3e5f5; }
        .proxy-label { position: absolute; top: -10px; left: 10px; background: #673ab7; color: white; padding: 2px 6px; font-size: 0.6rem; border-radius: 4px; }
        .check-step { width: 180px; background: white; border: 1px solid #999; left: 50%; margin-left: -90px; position: absolute; }
        .check-1 { top: 25px; }
        .check-2 { top: 65px; }
        .check-3 { top: 105px; }
        .check-4 { top: 145px; }
        .target { bottom: 10px; left: 50%; transform: translateX(-50%); background: #0288d1; color: white; width: 100px; padding: 10px; z-index: 2; }

        .log-console { height: 80px; background: #212121; color: #00e676; padding: 10px; font-family: monospace; font-size: 0.75rem; overflow-y: auto; border-radius: 4px; }
        .log-line { margin-bottom: 2px; border-bottom: 1px solid #333; }
        .log-err { color: #ff5252; }
        
        /* Syntax Highlighting for Sim */
        .kwd { color: #569cd6; } .str { color: #ce9178; } .cls { color: #4ec9b0; } .mtd { color: #dcdcaa; } .ann { color: #dcdcaa; } .com { color: #6a9955; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spring AOP Implementation Guide</h1>
        
        <div class="highlight">
            <strong>User Question:</strong> "Why were `Advice` and `JoinPoint` missing in the previous example?"<br>
            <strong>Answer:</strong> They were there, but implicit! 
            <ul>
                <li>The <strong>Method</strong> itself IS the <strong>Advice</strong>.</li>
                <li>The <strong>Arguments</strong> (`CreditCard card`) were bound from the <strong>JoinPoint</strong> automatically.</li>
            </ul>
        </div>

        <h2>1. Core Concepts (The "What")</h2>
        <div class="concept-box">
            <div class="concept-card">
                <div class="concept-title">Aspect (切面)</div>
                A class that contains the logic you want to apply (e.g., `RiskCheckAspect`). It's a combination of Pointcuts and Advice.
            </div>
            <div class="concept-card">
                <div class="concept-title">Pointcut (切点)</div>
                An expression that defines <em>WHERE</em> to apply the logic (e.g., "All methods with `@CheckCardRisk`").
            </div>
            <div class="concept-card">
                <div class="concept-title">Advice (通知)</div>
                The actual logic method (<em>WHAT</em> to do) and <em>WHEN</em> to do it (@Before, @After, @Around).
            </div>
            <div class="concept-card">
                <div class="concept-title">JoinPoint (连接点)</div>
                The specific execution point (the method call) being intercepted. You can access method names/args here.
            </div>
        </div>

        <h2>2. Implementation Steps (The "How")</h2>
        
        <h3>Step 1: Dependencies</h3>
        <pre>
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>

        <h3>Step 2: Enable AOP (Often automatic in Spring Boot)</h3>
        <pre>
<span class="annotation">@Configuration</span>
<span class="annotation">@EnableAspectJAutoProxy</span> <span class="comment">// Ensures AOP proxies are created</span>
<span class="keyword">public class</span> <span class="class-name">AppConfig</span> { ... }</pre>

        <h3>Step 3: Define the Aspect Class</h3>
        <pre>
<span class="annotation">@Aspect</span>      <span class="comment">// 1. Mark as Aspect</span>
<span class="annotation">@Component</span>   <span class="comment">// 2. Register as Bean (Crucial!)</span>
<span class="keyword">public class</span> <span class="class-name">LoggingAspect</span> {

    <span class="comment">// 3. Define Pointcut (Optional, can be inline)</span>
    <span class="annotation">@Pointcut</span>(<span class="string">"execution(* com.example.service.*.*(..))"</span>)
    <span class="keyword">public void</span> <span class="method">serviceLayer</span>() {}

    <span class="comment">// 4. Define Advice</span>
    <span class="annotation">@Before</span>(<span class="string">"serviceLayer()"</span>)
    <span class="keyword">public void</span> <span class="method">logBefore</span>(<span class="class-name">JoinPoint</span> joinPoint) {
        <span class="comment">// Logic here...</span>
    }
}</pre>

        <h2>3. Where is the JoinPoint? (Explicit vs Implicit)</h2>
        <p>In the previous demo, we used <strong>Argument Binding</strong> to get the `CreditCard` object directly. Here is the comparison:</p>

        <div class="comparison">
            <div class="comp-col">
                <div class="comp-header">Style A: Explicit JoinPoint (Generic)</div>
                <pre>
<span class="annotation">@Before</span>(<span class="string">"execution(* processPayment(..))"</span>)
<span class="keyword">public void</span> <span class="method">check</span>(<span class="class-name">JoinPoint</span> jp) {
    <span class="comment">// Manually get args array</span>
    <span class="class-name">Object</span>[] args = jp.getArgs();
    
    <span class="keyword">if</span> (args[0] <span class="keyword">instanceof</span> <span class="class-name">CreditCard</span>) {
        <span class="class-name">CreditCard</span> c = (<span class="class-name">CreditCard</span>) args[0];
        <span class="comment">// Validate c...</span>
    }
    
    <span class="class-name">System</span>.out.println(jp.getSignature().getName());
}</pre>
                <p><em>Good for generic logging where you don't know the exact arguments.</em></p>
            </div>

            <div class="comp-col">
                <div class="comp-header">Style B: Argument Binding (Clean)</div>
                <pre>
<span class="comment">// "args(card,..)" binds the first arg to 'card'</span>
<span class="annotation">@Before</span>(<span class="string">"@annotation(CheckRisk) && args(card,..)"</span>)
<span class="keyword">public void</span> <span class="method">check</span>(<span class="class-name">CreditCard</span> card) {
    
    <span class="comment">// No casting needed!</span>
    <span class="comment">// We have the object directly.</span>
    
    <span class="keyword">if</span> (!card.getLogo().equals(<span class="string">"VISA"</span>)) {
        <span class="keyword">throw new</span> <span class="class-name">Exception</span>(...);
    }
}</pre>
                <p><em>Used in the demo. Cleaner when you know exactly what object you are validating.</em></p>
            </div>
        </div>

        <h2>4. Controller Level Logging (Web Layer AOP)</h2>
        <div class="highlight">
            <strong>User Question:</strong> "I remember LoggingAspect is controller level?"<br>
            <strong>Answer:</strong> Yes! Logging is most commonly applied at the <strong>Controller Layer</strong> to capture HTTP requests (URL, IP, Method, Params) and Responses.
        </div>
        <pre>
<span class="annotation">@Aspect</span>
<span class="annotation">@Component</span>
<span class="keyword">public class</span> <span class="class-name">WebLogAspect</span> {

    <span class="comment">// Pointcut for all methods in Controller package</span>
    <span class="annotation">@Pointcut</span>(<span class="string">"execution(* com.example.controller..*.*(..))"</span>)
    <span class="keyword">public void</span> <span class="method">webLog</span>() {}

    <span class="annotation">@Before</span>(<span class="string">"webLog()"</span>)
    <span class="keyword">public void</span> <span class="method">doBefore</span>(<span class="class-name">JoinPoint</span> joinPoint) {
        <span class="comment">// Get Request Attributes</span>
        <span class="class-name">ServletRequestAttributes</span> attributes = (<span class="class-name">ServletRequestAttributes</span>) <span class="class-name">RequestContextHolder</span>.getRequestAttributes();
        <span class="class-name">HttpServletRequest</span> request = attributes.getRequest();

        <span class="comment">// Log URL, IP, Method</span>
        <span class="class-name">System</span>.out.println(<span class="string">"URL : "</span> + request.getRequestURL().toString());
        <span class="class-name">System</span>.out.println(<span class="string">"IP : "</span> + request.getRemoteAddr());
    }
}</pre>

        <h2>5. Interactive Demo: AOP Validation</h2>
        <p>Below is the interactive simulation of the <strong>Validation Aspect</strong> we discussed. It intercepts the `processPayment` call to check Credit Card details.</p>

        <div class="sim-container">
            <!-- Left: Code -->
            <div class="code-panel">
                <div class="tabs">
                    <div class="tab active" onclick="showCode('aspect')">RiskCheckAspect.java</div>
                    <div class="tab" onclick="showCode('service')">PaymentService.java</div>
                    <div class="tab" onclick="showCode('model')">CreditCard.java</div>
                </div>
                <div class="code-content" id="code-display">
                    <!-- Code injected by JS -->
                </div>
            </div>
    
            <!-- Right: Simulation -->
            <div class="sim-panel">
                <div class="form-group">
                    <div class="form-item">
                        <label>Logo</label>
                        <select id="logo">
                            <option value="VISA">VISA</option>
                            <option value="MASTERCARD">MASTERCARD</option>
                            <option value="UNKNOWN">UNKNOWN</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <label>Organization</label>
                        <input type="text" id="org" value="BANK_A">
                    </div>
                    <div class="form-item">
                        <label>Block Code</label>
                        <select id="blockcode">
                            <option value="">(None)</option>
                            <option value="LOST">LOST</option>
                            <option value="STOLEN">STOLEN</option>
                            <option value="FROZEN">FROZEN</option>
                        </select>
                    </div>
                    <div class="form-item">
                        <label>Risk Level (0-10)</label>
                        <input type="number" id="risk" value="0" min="0" max="10">
                    </div>
                </div>
    
                <button class="btn-run" onclick="runSimulation()">Invoke Payment API</button>
    
                <div class="flow-diagram">
                    <div class="node client" id="node-client">Client</div>
                    
                    <div class="proxy-box">
                        <div class="proxy-label">AOP Proxy (Around/Before)</div>
                        <div class="node check-step check-1" id="step-1">1. Check Logo<br><small>(Must be VISA/MC)</small></div>
                        <div class="node check-step check-2" id="step-2">2. Check Org<br><small>(Must be BANK_A)</small></div>
                        <div class="node check-step check-3" id="step-3">3. Check BlockCode<br><small>(Must be Empty)</small></div>
                        <div class="node check-step check-4" id="step-4">4. Check RiskLevel<br><small>(Must be < 5)</small></div>
                    </div>
    
                    <div class="node target" id="node-target">Target Service<br>processPayment()</div>
                </div>
    
                <div class="log-console" id="console">
                    <div class="log-line">> Ready.</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const codes = {
            aspect: `
<span class="ann">@Aspect</span>
<span class="ann">@Component</span>
<span class="kwd">public class</span> <span class="cls">RiskCheckAspect</span> {

    <span class="ann">@Before</span>(<span class="str">"@annotation(CheckCardRisk) && args(card,..)"</span>)
    <span class="kwd">public void</span> <span class="mtd">validateCard</span>(<span class="cls">CreditCard</span> card) {
        <span class="com">// 1. Check Logo</span>
        <span class="kwd">if</span> (!<span class="str">"VISA"</span>.equals(card.getLogo()) && !<span class="str">"MASTERCARD"</span>.equals(card.getLogo())) {
            <span class="kwd">throw new</span> <span class="cls">SecurityException</span>(<span class="str">"Invalid Card Logo"</span>);
        }

        <span class="com">// 2. Check Organization</span>
        <span class="kwd">if</span> (!<span class="str">"BANK_A"</span>.equals(card.getOrg())) {
            <span class="kwd">throw new</span> <span class="cls">SecurityException</span>(<span class="str">"Invalid Organization"</span>);
        }

        <span class="com">// 3. Check Block Code</span>
        <span class="kwd">if</span> (card.getBlockCode() != <span class="kwd">null</span> && !card.getBlockCode().isEmpty()) {
            <span class="kwd">throw new</span> <span class="cls">SecurityException</span>(<span class="str">"Card is Blocked: "</span> + card.getBlockCode());
        }

        <span class="com">// 4. Check Risk Level</span>
        <span class="kwd">if</span> (card.getRiskLevel() >= 5) {
            <span class="kwd">throw new</span> <span class="cls">SecurityException</span>(<span class="str">"Risk Level too high"</span>);
        }
    }
}`,
            service: `
<span class="ann">@Service</span>
<span class="kwd">public class</span> <span class="cls">PaymentService</span> {

    <span class="ann">@CheckCardRisk</span> <span class="com">// Custom Annotation</span>
    <span class="kwd">public void</span> <span class="mtd">processPayment</span>(<span class="cls">CreditCard</span> card, <span class="kwd">double</span> amount) {
        <span class="cls">System</span>.out.println(<span class="str">"Processing payment for "</span> + card.getLogo());
        <span class="com">// Business Logic...</span>
    }
}`,
            model: `
<span class="kwd">public class</span> <span class="cls">CreditCard</span> {
    <span class="kwd">private</span> <span class="cls">String</span> logo;
    <span class="kwd">private</span> <span class="cls">String</span> org;
    <span class="kwd">private</span> <span class="cls">String</span> blockCode;
    <span class="kwd">private</span> <span class="kwd">int</span> riskLevel;

    <span class="com">// Getters and Setters...</span>
}`
        };

        function showCode(type) {
            document.getElementById('code-display').innerHTML = codes[type];
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Init
        showCode('aspect');

        function log(msg, isErr = false) {
            const div = document.createElement('div');
            div.className = 'log-line' + (isErr ? ' log-err' : '');
            div.innerText = `> ${msg}`;
            const c = document.getElementById('console');
            c.appendChild(div);
            c.scrollTop = c.scrollHeight;
        }

        async function runSimulation() {
            // Reset UI
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('active', 'error', 'success');
            });
            document.getElementById('console').innerHTML = '';
            
            const logo = document.getElementById('logo').value;
            const org = document.getElementById('org').value;
            const block = document.getElementById('blockcode').value;
            const risk = parseInt(document.getElementById('risk').value);

            log("Client: Calling paymentService.processPayment()...");
            document.getElementById('node-client').classList.add('active');
            await wait(500);

            log("AOP Proxy: Intercepted call. Starting validation...");
            
            // Step 1: Logo
            await highlightStep('step-1');
            if (logo !== 'VISA' && logo !== 'MASTERCARD') {
                failStep('step-1', `Invalid Logo: ${logo}`);
                return;
            }
            passStep('step-1');

            // Step 2: Org
            await highlightStep('step-2');
            if (org !== 'BANK_A') {
                failStep('step-2', `Invalid Org: ${org}`);
                return;
            }
            passStep('step-2');

            // Step 3: Block
            await highlightStep('step-3');
            if (block !== '') {
                failStep('step-3', `Card Blocked: ${block}`);
                return;
            }
            passStep('step-3');

            // Step 4: Risk
            await highlightStep('step-4');
            if (risk >= 5) {
                failStep('step-4', `Risk Level High: ${risk}`);
                return;
            }
            passStep('step-4');

            // Target
            log("AOP: Validation Passed. Proceeding to Target.");
            await wait(500);
            const target = document.getElementById('node-target');
            target.classList.add('active', 'success');
            log("Service: Payment Processed Successfully!", false);
        }

        async function highlightStep(id) {
            const el = document.getElementById(id);
            el.classList.add('active');
            await wait(600);
        }

        function passStep(id) {
            const el = document.getElementById(id);
            el.classList.add('success');
            log(`Check ${id.split('-')[1]} Passed.`);
        }

        function failStep(id, msg) {
            const el = document.getElementById(id);
            el.classList.add('error');
            log(`Exception: ${msg}`, true);
            log("AOP: Execution halted. Target NOT called.", true);
        }

        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    </script>
</body>
</html>